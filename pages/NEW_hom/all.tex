\documentclass[12pt]{article}


%\usepackage{showkeys}
\usepackage{hyperref}
\usepackage{amsmath, amssymb, amsthm, bm}
\usepackage[sort&compress,numbers]{natbib}
\usepackage{doi}
\usepackage[margin=0.8in]{geometry}
\usepackage[all]{xy}
\usepackage{mathrsfs} 
%\textheight23cm \topmargin-20mm  
%\textwidth175mm  
%\oddsidemargin=0mm
%\evensidemargin=0mm
%

\usepackage{amsmath, amsthm, mathtools}

\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{Theorem}
\newtheorem{coro}{Corollary}
\newtheorem{prop}{Proposition}


\theoremstyle{definition}
\newtheorem{defi}{Definition}


\theoremstyle{remark}
\newtheorem{remark}{Remark}
\newtheorem{exm}{Example}

\def\aff{\operatorname{Aff}}
\def\lin{\operatorname{Lin}}
\def\Span{\operatorname{Span}}
\def\type{\mathrm {setting}}
\def\ii{\bm{\emptyset}}
\def\tt{\bm{0}}
\def\Ce{\mathcal C}
\def\Ae{\mathcal A}
\def\Me{\mathcal M}
\def\Le{\mathcal L}
\def\Te{\mathcal T}
\def\Fe{\mathcal F}
\def\Pe{\mathcal P}
\def \Tr{\mathrm{Tr}\,}
\def\Se {\mathcal S}
\def\supp{\mathrm{supp}}
\def\permut{\mathscr{S}}

\def\<{\langle\,}
\def\>{\,\rangle}
%\def \BS{\mathrm{BS}}
\def\vtl{\vartriangleleft}
\def\vtr{\vartriangleright}
\def \Afh{\mathrm{AfH}}
\def \Af{\mathrm{Af}}
\def \FV{\mathrm{FinVect}}
\def\bV{\mathbf V}
\def\bW{\mathbf W}
\def\bE{ E}
\def\bI{I}

\def\Cl{\mathrm{Clas}}
\def\Quant{\mathrm{Quant}}
\def\bX{ X}
\def\bQ{\mathbf Q}
\def\bY{ Y}
\def\bZ{Z}

\makeatletter

\newcommand*\@bigplus[1]{\vcenter{\hbox{#1$\m@th +$}}}
\newcommand*\bigplus{%
    \DOTSB % omit this line if you are not using the amsmath package
    \mathop{%
        \mathchoice
            {\@bigplus \huge}%
            {\@bigplus \LARGE}%
            {\@bigplus {}}%
            {\@bigplus \footnotesize}%
    }%
    \slimits@ % omit this line if you are not using the amsmath package
}

\makeatother




\title{On the structure of  higher order quantum maps}
\author{Anna Jen\v cov\'a}

\begin{document}

\maketitle

\section{Affine subspaces and higher order maps}

\subsection{The category $\FV$} \label{sec:fv}

Let  $\FV$ be the category of finite dimensional real vector spaces with linear maps. 
We will denote the usual tensor product by $\otimes$, then  $(\FV,\otimes, I=\mathbb R)$
is a symmetric monoidal category, with the associators, unitors and symmetries given by
the obvious isomorphisms 
\begin{align*}
\alpha_{U,V,W}&:(U\otimes V)\otimes W\simeq U\otimes (V\otimes W), \\
\lambda_V&: I\otimes
V\simeq
V, \qquad \rho_V: V\otimes I\simeq V,\\
\sigma_{U,V}&: U\otimes V\simeq V\otimes U.
\end{align*}




Let  $(-)^*: V\mapsto V^*$ be the usual vector space dual, with duality denoted by
$\<\cdot,\cdot\>: V^*\times V\to \mathbb R$. We will use the canonical identification
$V^{**}=V$ and $(V_1\otimes V_2)^*=V_1^*\otimes V_2^*$. With this duality, $\FV$ is
compact closed. This means that for each object $V$, there are morphisms $\eta_V: I\to V^*\otimes
V$ (the ''cup'') and $\epsilon_V: V\otimes V^*\to I$ (the ''cap'') such that the following snake
identities hold:
\begin{equation}\label{eq:snake}
(\epsilon_V\otimes V)\circ (V\otimes \eta_V)=V,\qquad (V^*\otimes \epsilon_V)\circ
(\eta_V\otimes V^*)=V^*,
\end{equation}
here we denote the identity map on the object $V$ by $V$. Let us identify these morphisms.
First, $\eta_V$ is a linear map $\mathbb R\to V^*\otimes V$, which can be
identified with the element $\eta_V(1)\in V^*\otimes V$ and   $\epsilon_V\in (V\otimes
V^*)^*=V^*\otimes V$ is again an element of the same space.  Choose a basis
$\{e_i\}$ of $V$, let $\{e_i^*\}$ be the dual basis of $V^*$, that is,
$\<e_i^*,e_j\>=\delta_{i,j}$. Let us define
\[
\eta_V(1)=\epsilon_V:=\sum_i e_i^*\otimes e_i.
\]
It is easy to see that this definition does not depend on the choice of the basis, indeed,
$\epsilon_V$ is the linear functional on $V\otimes V^*$ defined by
\[
\<\epsilon_V, x\otimes x^*\>=\<x^*,x\>,\qquad x\in V, \ x^*\in V^*.
\]
It is also easily checked that the snake identities \eqref{eq:snake} hold.

For two objects $V$ and $W$ in $\FV$, we will denote the set of all morphisms (i.e. linear
maps) $V\to
W$ by $\FV(V,W)$. Then $\FV(V,W)$ is itself a real linear space and  we have the well-known identification 
$\FV(V,W)\simeq V^*\otimes W$. This can be given as follows: for each $f\in \FV(V,W)$, we have 
$C_f:=(V^*\otimes f)(\epsilon_V)=\sum_i e_i^*\otimes f(e_i)\in V^*\otimes W$. Conversely,
since $\{e_i^*\}$ is a basis of $V^*$, 
any element $w\in V^*\otimes W$ can be uniquely written as $w=\sum_i e_i^*\otimes w_i$ for
$w_i\in W$, and since $\{e_i\}$ is a basis of $V$, the assignment $f(e_i):=w_i$ determines a
unique map $f:V\to W$. The relations between $f\in \FV(V,W)$ and $C_f\in V^*\otimes W$ can
be also written as
\[
\<C_f,x\otimes y^*\>=\<\epsilon_V,x\otimes f^*(y^*)\>=\<f^*(y^*),x\>=\<y^*,f(x)\>,\qquad x\in
V,\ y^*\in W^*,
\]
here $f^*:W^*\to V^*$ is the adjoint of $f$.
Note that by compactness, the internal hom in $\FV$ satisfies $[V,W]\simeq V^*\otimes W$,
so that  in the case of $\FV$, the object $[V,W]$ can be identified with the space of linear
maps $\FV(V,W)$. 

We now present two examples that are most important for us.

\begin{exm}\label{exm:classical} Let $V=\mathbb R^N$. In this case, we fix the canonical basis $\{|i\>,\
i=1,\dots,N\}$. We will identify $(\mathbb R^N)^*=\mathbb R^N$, with duality
$\<x,y\>=\sum_i x_iy_i$, in particular, we identify $I=I^*$. We then have
$\epsilon_V=\sum_i |i\>\otimes |i\>$ and if $f:\mathbb R^N\to \mathbb R^M$ is given by the
matrix $A$ in the two canonical bases, then  $C_f=\sum_i |i\>\otimes A|i\>$ is the
vectorization of $A$.

\end{exm}


\begin{exm}\label{exm:quantum} Let $V=M_n^h$ be the space of $n\times n$ complex hermitian matrices. We again
identify $(M_n^h)^*=M_n^h$, with duality $\<A,B\>=\Tr A^TB$, where $A^T$ is the usual
transpose of the matrix $A$. Let us choose the basis in $M_n^h$, given as
\[
\left\{|j\>\<k|+|k\>\<j|,\ j\le k,\ i\biggl(|j\>\<k|-|k\>\<j|\biggr),\ j<k\right\}.
\]
Then one can check that
\[
\left\{\frac12\biggl(|j\>\<k|+|k\>\<j|\biggl),\ j\le k,\
\frac{i}{2}\biggl(|k\>\<j|-|j\>\<k|\biggr),\ j<k\right\}
\]
is the dual basis and we have
\[
\epsilon_V=\sum_{j,k} |j\>\<k|\otimes |j\>\<k|.
\]
For any $f:M_n^h\to M_m^h$, 
\[
C_f=\sum_{j,k} |j\>\<k|\otimes f(|j\>\<k|)
\]
is the Choi matrix of $f$.

\end{exm}





\subsection{The category $\Af$}

We now introduce the category $\Af$, whose objects  are of the form $X=(V_X,A_X)$, where
$V_X$ is an object in $\FV$  and $A_X\subseteq V_X$ is a proper affine subspace, see Appendix
\ref{sec:app_affine} for definitions and basic properties. Morphisms $X\xrightarrow{f} Y$ in $\Af$ are linear maps $f:V_X\to V_Y$  such that
$f(A_X)\subseteq A_Y$. For any object $X$, we put
\begin{align*}
L_X:=\lin(A_X), \quad  S_X:=\Span(A_X), \quad D_X=\dim(V_X),\quad d_X=\dim(L_X).
\end{align*}
We have
\begin{equation}\label{eq:ALS}
A_X=a+L_X=S_X\cap \{\tilde a\}^{\sim},
\end{equation}
for any choice of elements $a\in A_X$ and $\tilde a\in \tilde A_X$.
We now introduce a tensor product  and duality that endow $\Af$ with the structure of a
*-autonomous category.


By Corollary \ref{coro:dual},  the dual $\tilde A_X$ is a proper affine subspace in $V_X^*$, so that
$X^*:=(V_X^*,\tilde A_X)$ is an object in $\Af$. We have $X^{**}=X$ and the corresponding subspaces
are related as
\begin{equation}\label{eq:duality}
L_{X^*}=S_X^\perp,\qquad S_{X^*}=L_X^\perp.
\end{equation}
It is easily seen that for any  $X\xrightarrow{f} Y$, the adjoint map satisfies $f^*(\tilde
A_Y)\subseteq \tilde A_X$, so that $Y^*\xrightarrow{f^*} X^*$ and the duality $(-)^*$ is a
full and faithful functor 
$\Af^{op}\to \Af$.

We will next introduce a monoidal structure $\otimes$ as follows. For two objects $X$ and
$Y$, we put  $V_{X\otimes Y}=V_X\otimes V_Y$ and construct the affine subspace
$A_{X\otimes Y}$ as the affine span of 
\[
A_X\otimes A_Y=\{a\otimes b,\ a\in A_X,\ b\in A_Y\}.
\]
Fix any $\tilde a_X\in \tilde A_X$ and $\tilde a_Y\in \tilde A_Y$. 
Since $A_X\otimes A_Y\subseteq \{\tilde a_X\otimes \tilde a_Y\}^\sim$, the affine span of
$A_X\otimes A_Y$ is a proper affine subspace and we have by Lemma \ref{lemma:dual}
\[
A_{X\otimes Y}:=\aff(A_X\otimes A_Y)=\{A_X\otimes A_Y\}^{\approx}.
\]
\begin{lemma}\label{lemma:tensor_spaces}
For any $a_X\in A_X$, $a_Y\in A_Y$, we  have
\begin{align}
L_{X\otimes Y}&=\lin(A_X\otimes A_Y)=\Span(\{x\otimes y-a_X\otimes a_Y,\ x\in A_X,\ y\in
A_Y\})\label{eq:lxy1}\\
&= (a_X\otimes L_Y)+ (L_X\otimes a_Y)+ (L_X\otimes L_Y)\label{eq:lxy}
%\\ &= S_X\otimes L_Y+L_X\otimes a_Y=a_X\otimes L_Y+L_X\otimes S_Y
\end{align}
(here $+$ denotes the direct sum of subspaces). We also have
\[
S_{X\otimes Y}=S_X\otimes S_Y.
\]
\end{lemma}

\begin{proof} The equality \eqref{eq:lxy1} follows from Lemma \ref{lemma:dual}. For any $x\in A_X$, $y\in A_Y$
 we have
\[
x\otimes y-a_X\otimes a_Y=a_X\otimes (y-a_Y)+(x-a_X)\otimes a_Y+(x-a_X)\otimes (y-a_Y),
\]
so that $L_{X\otimes Y}=\lin(A_X\otimes A_Y)$ is contained in the subspace on the RHS of \eqref{eq:lxy}.
Let $d$ be the dimension of this subspace, then clearly
\[
d_{X\otimes Y}\le d\le d_X+d_Y+d_Xd_Y.
\]
On the other hand, any element of $S_X$ has the form $tx$ for some $t\in \mathbb R$ and
$x\in A_X$, so that it is easily seen that $S_X\otimes S_Y=S_{X\otimes Y}$. 
Hence 
\begin{align*}
d_{X\otimes Y}&=\dim(L_{X\otimes Y})=\dim(S_{X\otimes
Y})-1=\dim(S_X)\dim(S_Y)-1=(d_X+1)(d_Y+1)-1\\
&=d_X+d_Y+d_Xd_Y.
\end{align*}
This completes the proof.

\end{proof}




\begin{lemma}\label{lemma:monoidal} Let $I=(\mathbb R,\{1\})$. Then 
$(\Af,\otimes, I)$ is a symmetric monoidal category.
\end{lemma}

\begin{proof} Note that this structure is inherited from the symmetric monoidal structure
in $\FV$. To show that $\otimes$ is a functor, we have to check that for $X_1\xrightarrow{f} Y_1$ and $X_2\xrightarrow{g} Y_2$ in
$\Af$, we have $X_1\otimes Y_1\xrightarrow{f\otimes g} X_2\otimes Y_2$ which amounts to
showing that 
\[
(f\otimes g)(A_{X_1\otimes Y_1})\subseteq A_{X_2\otimes Y_2}.
\]
Let $x\in A_{X_1}$, $y\in A_{Y_1}$, then $f(x)\otimes g(y)\in A_{X_2}\otimes
A_{Y_2}\subseteq A_{X_2\otimes Y_2}$. Since  $A_{X_1\otimes Y_1}$ is the affine subspace
generated by $A_{X_1}\otimes A_{Y_1}$, the above inclusion follows by linearity of $f\otimes
g$. 

It only remains to prove that the associators, unitors and symmetries from
$\FV$ are morphisms in $\Af$. We will prove this for the associators $\alpha_{X,Y,Z}:V_X\otimes (V_Y\otimes V_Z)\to
(V_X\otimes V_Y)\otimes V_Z$, the other proofs are similar. We need to check that
$\alpha_{X,Y,Z}(A_{X\otimes(Y\otimes Z)})\subseteq A_{(X\otimes Y)\otimes Z}$. It is easily
checked that $A_{X\otimes(Y\otimes Z)}$ is the affine span of elements of the form
$x\otimes (y\otimes z)$, $x\in A_X$, $y\in A_Y$ and $z\in A_Z$, and we have
\[
\alpha_{X,Y,Z}(x\otimes (y\otimes z))=(x\otimes y)\otimes z\in A_{(X\otimes Y)\otimes Z}
\]
for all such elements. The desired inclusion follows by linearity.

\end{proof}


\begin{theorem} $(\Af,\otimes,I)$ is a *-autonomous category, with duality $(-)^*$, such
that $I^*=I$.

\end{theorem}


\begin{proof} By Lemma \ref{lemma:monoidal}, we have that $(\Af,\otimes, I)$ is a symmetric
monoidal category. We have also seen that the duality $(-)^*$ is a full and faithful
contravariant functor. We only need to check the natural isomorphisms 
\[
\Af(X\otimes Y,Z^*)\simeq \Af(X,(Y\otimes Z)^*).
\]
Since $\FV$ is compact, we have the natural isomorphisms
\[
\FV(V_X\otimes V_Y,V^*_Z)\simeq \FV(V_X,V_Y^*\otimes V_Z^*),
\]
determined by the equalities
\[
\<f(x\otimes y),z\>=\<\hat f(x),y\otimes z\>,\qquad x\in V_X,\ y\in V_Y,\ z\in V_Z,
\]
for $f\in \FV(V_X\otimes V_Y,V_Z^*)$ and the corresponding morphism  $\hat f\in \FV(V_Z,V_Y^*\otimes V_Z^*)$. Since
$A_{X\otimes Y}$ is an affine span of $A_X\otimes A_Y$, we see that
$f$ is in $\Af(X\otimes Y, Z^*)$ if and only if $f(x\otimes y)\in \tilde A_Z$ for all $x\in A_X$, $y\in
A_Y$, that is, 
\[
1=\<f(x\otimes y),z\>=\<\hat f(x),y\otimes z\>\qquad \forall x\in A_X,\
\forall y\in A_Y,\ \forall z\in A_Z.
\]
But this is equivalent to
\[
\hat f(x)\in (A_Y\otimes A_Z)^\sim=\tilde A_{Y\otimes Z},\qquad \forall x\in A_X,
\]
which means that $\hat f\in \Af(X, (Y\otimes Z)^*)$.

\end{proof}
A *-autonomous category is compact closed if it satisfies $(X\otimes Y)^*=X^*\otimes
Y^*$. 
In general, $X\odot Y=(X^*\otimes Y^*)^*$ defines a dual symmetric monoidal
structure that is different from $\otimes$. 
We next show that $\Af$ is not compact.

\begin{prop}\label{prop:noncompact} For objects in $\Af$, we have $(X\otimes
Y)^*=X^*\otimes Y^*$ exactly in one of the following situations:
\begin{enumerate}
\item[(i)] $X\simeq I$ or $Y\simeq I$,
\item[(ii)] $d_X=d_Y=0$,
\item[(iii)] $d_{X^*}=d_{Y^*}=0$.
\end{enumerate}



\end{prop}

\begin{proof} Since $\FV$ is compact, we have $V_{(X\otimes Y)^*}=(V_X\otimes
V_Y)^*=V_X^*\otimes V_Y^*=V_{X^*\otimes Y^*}$. It is also easily seen by definition that $A_{X^*}\otimes A_{Y^*}=\tilde A_X\otimes \tilde
A_Y\subseteq \tilde A_{X\otimes Y}=A_{(X\otimes Y)^*}$, so that we always have $A_{X^*\otimes
Y^*}\subseteq A_{(X\otimes Y)^*}$.  Hence the equality holds if and
only if $d_{X^*\otimes Y^*}=d_{(X\otimes Y)^*}$. From Lemma
\ref{lemma:tensor_spaces}, we see that
\[
d_{X^*\otimes Y^*}=d_{X^*}+d_{Y^*}+d_{X^*}d_{Y^*}.
\]
On the other hand, we have using \eqref{eq:duality} that $L_{(X\otimes Y)^*}=S_{X\otimes
Y}^\perp=(S_X\otimes S_Y)^\perp$, so that
\[
d_{(X\otimes Y)^*}=D_XD_Y-\dim(S_X)\dim(S_Y)=D_XD_Y-(d_X+1)(d_Y+1).
\]
Taking into account that by \eqref{eq:duality} we have $d_{X^*}=D_X-d_{X}-1$, similarly
for $d_{Y^*}$, we obtain

\[
d_{(X\otimes Y)^*}-d_{X^*\otimes Y^*}=d_Xd_{Y^*}+d_{X^*}d_Y.
\]
This is equal to 0 iff $d_Xd_{Y^*}=d_Yd_{X^*}=0$, which amounts to the conditions in the
lemma.

\end{proof}



In a *-autonomous category, the internal hom can be identified as $[X,Y]=(X\otimes
Y^*)^*$. The underlying vector space is $V_{[X,Y]}=(V_X\otimes V_Y^*)^*=V_X^*\otimes V_Y$
and we have seen in Section \ref{sec:fv} that we may identify this space with
$\FV(V_X,V_Y)$, by $f \leftrightarrow C_f$. This property is extended to $\Af$, in the
following sense.

\begin{prop}\label{prop:ihom_morphisms} For any objects $X,Y$ in $\Af$, the map $f\mapsto C_f$ is a bijection
of $\Af(X,Y)$ onto $A_{[X,Y]}$. In particular,  $\tilde A_X$ can be identified with
$\Af(X,I)$.

\end{prop}

\begin{proof} Let $f\in \FV(V_X,V_Y)$. Since by definition $A_{[X,Y]}=\tilde A_{X\otimes
Y^*}=(A_X\otimes A_Y^*)^\sim$, we see that $C_f\in A_{[X,Y]}$ if and only
if for all $x\in A_X$ and $y^*\in \tilde A_Y$, we have
\[
1=\<C_f, x\otimes y^*\>=\<y^*,f(x)\>.
\]
This latter statement is clearly equivalent to $f(A_X)\subseteq A_Y$, so that $f\in
\Af(X,Y)$. 

\end{proof}

In the next result, we restrict the objects to spaces of hermitian matrices, as in Example
\ref{exm:quantum} and morphisms to completely positive maps. We show that this restriction
amounts to taking an intersection of $A_{[X,Y]}$ with the cone of positive semidefinite
matrices. This, and subsequent examples,  shows that for characterization of sets  of quantum
objects such as states, channels, combs and transformations between them, it is enough to
work with the category $\Af$. 

An object $X$ of $\Af$ will be called quantum if $V_X=M_n^h$ for some $n$ and $A_X$ is an
affine subspace such that both $A_X$ and $\tilde A_X$ contain a positive multiple of the identity matrix
$E_n$\footnote{We use the notation $E_n$, and not $I_n$, to avoid the slight chance that
it might be confused with the monoidal unit.}.
%have nonempty intersection with the
%interior of the positive cone $int(M_n^+)$ 
(recall that we identify $(M_n^h)^*=M_n^h$). 
%A quantum object will be called standard if both $A_X$ and $\tilde A_X$  




\begin{prop}\label{prop:ihom_quantum} Let $X$, $Y$ be quantum objects in $\Af$. Then 
\begin{enumerate}
\item[(i)] $X^*$ and $X\otimes Y$ are quantum objects as well. 
%If $X$ and $Y$ are standard, then so are $X^*$ and $X\otimes Y$.
\item[(ii)] Let $V_X=M_n^h$, $V_Y=M_m^h$. Then for any $f\in \FV(M_n^h,M_m^h)$, we have
$C_f\in A_{[X,Y]}\cap M_{mn}^+$ if and only if $f$ is completely positive and
\[
f(A_X\cap M_n^+)\subseteq A_Y\cap M_m^+.
\]
\end{enumerate}


\end{prop}

\begin{proof} The statement (i) is easily seen from  $A_X\otimes A_Y
\subseteq  A_{X\otimes Y}$ and $\tilde A_X\otimes \tilde A_Y\subseteq \tilde A_{X\otimes
Y}$. % together with the fact that $int(M_n^+)\otimes int(M_m^+)\subseteq int(M_{mn}^+)$. 
To show (ii), let $C_f\in   A_{[X,Y]}\cap M_{mn}^+$. By the properties of the Choi
isomorphism $f$ is completely positive and by Proposition \ref{prop:ihom_morphisms},
$f(A_X)\subseteq A_Y$, this proves one implication. For the converse, note that we only
need to prove that under the given assumptions, $f(A_X)\subseteq A_Y$, for which it is enough
to show that $A_X\subseteq \aff(A_X\cap M_n^+)$. To see this, let  $c_XE_n\in  A_X$ for
$c_X>0$.  Any element in $A_X$ can be written in the form $c_XE_n+v$ for some $v\in L_X$.
Since $c_XE_n\in int(M_n^+)$, there is some $s>0$ such that $a_\pm:=c_XE_n\pm sv\in M_n^+$, and
since $\pm sv\in L_X$, we see that $a_\pm \in A_X\cap M_n^+$. It is now easily checked
that
\[
c_XE_n+v=\frac{1+s}{2s}a_++\frac{s-1}{2s}a_-\in \aff(A_X\cap M_n^+). 
\]


\end{proof}

We can define classical objects in $\Af$ in a similar way, replacing $M_n^h$ by $\mathbb
R^N$ and the positive cone by $\mathbb R_+^N$, and we require that  both
$A_X$ and $\tilde A_X$ contains a positive multiple of the unit vector $e_N=(1,\dots,1)\in
\mathbb R^N$. A similar statement holds in this case,
with complete positivity replaced by positivity. We can similarly treat
classical-to-quantum and quantum-to-classical maps as morphisms between these types of
objects, satisfying appropriate positivity assumptions.

\begin{exm}[Higher order quantum maps] \label{exm:quantum_maps} The basic example of a quantum object
corresponds to the set of quantum states. Let  
\[
\mathcal A_n:=\{T\in M_n^h, \ \Tr[T]=1\}.
\]
Then $\Se_n:=(M_n^h,\mathcal A_n)$ is an object in $\Af$, and it is a quantum object, since we have 
 $E_n\in \tilde {\mathcal A}_n=\{E_n\}$ and $\frac 1n E_n\in
\mathcal A_n$. 
The set $\mathcal A_n\cap M_n^+$ is the set of quantum states. By Proposition
\ref{prop:ihom_morphisms}, $\Ce_{m,n}:=[\Se_m,\Se_n]$ is a quantum object as well, such
that the corresponding vector space is $M_{mn}^h$ and $A_{\Ce_{m,n}}\cap M_{mn}^+$ is the set
of Choi matrices of quantum channels $M_m\to M_n$. Note that the dual object
$\Ce^*_{m,n}=\Se_m\otimes \Se_n^*$ represents the set of Choi matrices of replacement
channels $\Se_n\to \Se_m$, that is, channels that map any state in $M_n$ to a fixed state
in $M_m$. We also have $\Se_n=[\Se_n,I]=\Ce_{n,1}$.

The set of higher order quantum maps is constructed inductively from the channel objects $\Ce_{m,n}$ 
by applying the internal hom $[\cdot,\cdot]$. For example,  $[\Ce_{m,n},\Ce_{k,l}]$ is a
 quantum object, corresponding to the set of Choi matrices of quantum
superchannels, or 2-combs, etc. Note that in this way we always obtain quantum
objects. The corresponding affine subspaces are identified using 
\eqref{eq:ALS} with $a$ and $\tilde a$ replaced by the appropriate multiple of the
identity, together with \eqref{eq:duality} and Lemma \ref{lemma:tensor_spaces}.


\end{exm}


\begin{exm}[Partially classical maps]\label{exm:quantum_classical}  We may similarly define the basic
classical object as 
\[
\Pe_N:=(\mathbb R^N, \{x,\ \sum_i x_i=1\}).
\]
In this case, $\mathcal A_{\Pe_N}\cap \mathbb R^N_+$ is the probability simplex. We then
obtain further  useful objects by combining with the quantum objects. For example, it can be
easily seen that $[\Se_n,\Pe_N]$ corresponds to $N$-outcome measurements,
$[\Se_m,\Se_n\otimes \Pe_N]$ to $N$-outcome quantum instruments, $[\Se_m\otimes
\Pe_N,\Pe_M]$ to quantum multimeters, etc. 

\end{exm}




\subsection{First order and higher order objects}


We say that an object $X$ in $\Af$ is first order if $d_X=D_X-1$, equivalently, $S_X=V_X$.
Another equivalent condition is $d_{X^*}=0$, which means that $A_X$ is determined by a
single element $\tilde a_X\in V_X^*$ as 
\[
A_X=\{\tilde a_X\}^\sim,\qquad \tilde A_X=\{\tilde a_X\}.
\]
Note that first order objects, resp. their duals, are exactly those satisfying
condition (iii), resp. condition (ii), in Proposition \ref{prop:noncompact}, in
particular, $(X\otimes Y)^*=X^*\otimes Y^*$ for first order objects $X$ and $Y$.


{\em Higher order objects} in $\Af$ are objects  obtained from a finite set $\{X_1,\dots,X_n\}$ of first order objects by
taking tensor products and duals. The above is indeed a set, so that all the objects are
different (though they may be isomorphic) and the ordering is not essential. We will also
assume that the monoidal  unit $I$ is not contained in this set. By definition of $[X,Y]$, and since we may dentify $[X,I]$ with $X^*$, we see that higher order objects are
also generated by applying the internal hom inductively on $\{X_1,\dots, X_n\}$ if we allow $X_i=I$ for some  
$i$. It follows that the ''higher order quantum maps'' in Example \ref{exm:quantum_maps}
are indeed higher order objects in $\Af$  according to the above definition.


Of course, any first order
object is also higher order with $n=1$. Note that we cannot say that a higher order object
generated from $\{X_1,\dots, X_n\}$ is automatically ''of order $n$'', as the following lemma shows. 

\begin{lemma}\label{lemma:1ordertensor} Let $X$, $Y$ be first order, then $X\otimes Y$ is
first order as well.

\end{lemma}

\begin{proof} We have $S_{X\otimes Y}=S_X\otimes S_Y=V_X\otimes V_Y=V_{X\otimes Y}$.

\end{proof}

As we have seen, higher order objects are obtained by applying the internal hom
iteratively. The following properties of such iterations are easily seen from the
definition of $[\cdot,\cdot]$. 

\begin{lemma}\label{lemma:combs} Let $X,Y,Z$ be any objects in $\Af$. Then we have
\begin{enumerate}
\item[(i)] $[Z,[X,Y]]\simeq [X,[Z,Y]]$.
\item[(ii)] If $X=(V_X,\{\tilde a_X\}^\sim)$ and $Y=(V_Y, \{\tilde a_Y\}^\sim)$ are first order, 
then $[Z,[X,Y]]$ is determined as
\[
A_{[Z,[X,Y]]}=\{w\in V_{Z}^*\otimes V_X^*\otimes V_Y, (id\otimes \tilde a_Y)(w)\in
A_Z^*\otimes \tilde a_X\}.
\]

\end{enumerate}


\end{lemma}



\begin{exm}[Combs] The higher order objects called $n$-combs are constructed inductively as follows. 
1-combs, or channels, are objects of the form $[X,Y]$, with  first order objects $X$ and $Y$. An
$n$-comb is an object of the form $[C_{n-1},[X,Y]]$, where $C_{n-1}$ is an $n-1$-comb and
$X$, $Y$ are first order objects. Using Lemma \ref{lemma:combs}, we see that an $n$-comb
has the form
\[
[X_{2n-1},[[X_{2n-3},\dots,[[X_1,X_2],X_4]],\dots,X_{2n}]]
\]
for first order objects $X_1,X_2,\dots,X_{2n}$. For quantum objects, we see that
an $n$-comb describes the sets of $n$-combs introduced in {}, see Example
\ref{exm:quantum_maps} (We slightly  abuse
the terminology here).

Since $[X,Y]\simeq [I,[X,Y]]$, we can determine the affine subspace of the channel object $[X,Y]$
using Lemma \ref{lemma:combs}(ii) as
\[
A_{[X,Y]}=\{w\in V_X^*\otimes V_Y,\ (id\otimes \tilde a_Y)(w)=\tilde a_X\}.
\]
The subspace $A_{C_n}$ for an $n$-comb $C_n$ can be found inductively. 

\end{exm}




\section{Combinatorial description of higher order objects}

In this section, we discuss a combinatiorial description of higher order objects similar
to that of [Pavia]. We will use the definitions and results given in Appendix
\ref{sec:boolean}.

For a first order object $X=(V_X, \{\tilde a_X\}^\sim)$, let us pick an element $a_X\in
A_X$. We have a direct sum decomposition
\[
V_X=L_{X,0}\oplus L_{X,1},
\]
where $L_{X,0}:= \mathbb R\{a_X\}$, $L_{X,1}:=\{\tilde a_X\}^\perp=L_X$.
We define the {\em conjugate object}  as $\tilde X=(V_X^*,\{a_X\}^\sim)$. Note that we always
have $\tilde a_X\in A_{\tilde X}$ and with the choice $a_{\tilde X}=\tilde a_X$, we obtain 
$\tilde{\tilde X}=X$ and 
\begin{equation}\label{eq:complement}
L_{\tilde X,u}=L_{X,1-u}^\perp,\qquad u\in \{0,1\}.
\end{equation}

These  definitions depend on the choice of $a_X$, but we will assume below that this
choice is fixed and that we choose $a_{\tilde X}=\tilde a_X$. Since we will always work
with a finite set of objects at a time, this will not create any problems. 

 A  first order quantum
or classical object  is the set of states $\Se_n$ or the set of probability distributions
$\Pe_N$, see Examples \ref{exm:quantum_maps}, \ref{exm:quantum_classical}.
In these cases, $a_X$ will be chosen as the appropriate multiple of the identity.
 Note that then
 \[
L_{X,0}=L_{\tilde X,0}= \mathbb R\{E_n\},\qquad  L_{X,1}=L_{\tilde X,1}= \Te_n:=\{T\in
M_n^h, \Tr[T]=0\}
 \]
(similarly for $\Pe_N$). 


Let $X_1,\dots,X_n$ be first order objects in $\Af$. Let $a_{X_i}\in A_{X_i}$ be fixed and
let $\tilde X_i$ be the conjugate first order objects. Let us denote $V_i=V_{X_i}$ and 
\[
L_{i,u}:= L_{X_i,u},\qquad  \tilde L_{i,u}:= L_{\tilde X_i,u} \qquad u\in \{0,1\},\ i\in [n].
\]
For a string $s\in \{0,1\}^n$, we define
\[
L_s:=L_{1,s_1}\otimes\dots \otimes L_{n,s_n}, \qquad \tilde L_s:=\tilde
L_{1,s_1}\otimes\dots \otimes \tilde L_{n,s_n},
\]
then we have the direct sum decompositions 
\[
V:=V_1\otimes \dots \otimes V_n=\sum_{s\in \{0,1\}^n} L_s,\qquad V^*=V_1^*\otimes
\dots\otimes V_n^*=\sum_{s\in \{0,1\}^n} \tilde L_s
\]
(here $\sum$ denotes the direct sum).


\begin{lemma}\label{lemma:Lperp}   For any $s\in \{0,1\}^n$, we have 
\[
L_s^\perp=
\sum_{t\in\{0,1\}^n} (1-{\chi}_s(t))\tilde L_t,\qquad \tilde L_s^\perp=
\sum_{t\in\{0,1\}^n} (1-{\chi}_s(t))L_t.
\]
Here $\chi_s:\{0,1\}^n\to\{0,1\}$ is the characteristic function of $s$. 

\end{lemma}

\begin{proof} Using \eqref{eq:complement} and the direct sum decomposition of $V_i^*$, we get
\begin{align*}
\left(L_{1,s_{1}}\otimes \dots\otimes L_{n,s_{n}}\right)^\perp&= \bigvee_j\left(
V_{1}^*\otimes
\dots \otimes V_{j-1}^*\otimes \tilde L_{j,1-s_{j}}\otimes V_{j+1}^*\otimes\dots \otimes
V_{n}^*\right)\\
&= \bigvee_j \left( \sum_{\substack{t\in \{0,1\}^n\\ t_{j}\ne s_{j}}} \tilde
L_{1,t_{1}}\otimes\dots \otimes \tilde
L_{n,t_{n}}\right)\\
&= \sum_{\substack{t\in \{0,1\}^n\\ t\ne s}} \left( \tilde L_{1,t_{1}}\otimes\dots \otimes \tilde
L_{n,t_{n}}\right).
\end{align*}
The proof of the other equality is the same.

\end{proof}



\begin{lemma}\label{lemma:Xf} Put $a:= a_1\otimes\dots \otimes  a_n$, $\tilde a:= \tilde
a_1\otimes\dots\otimes  \tilde a_n$.
For  $f\in \Fe_n$ define 
\[
S_f=S_f(X_1,\dots,X_n):=\sum_{s\in \{0,1\}^n} f(s)L_s,\qquad A_f=A_f(X_1,\dots,X_n):=S_f\cap \{\tilde a\}^\sim.
\]
Then $A_f$ is a proper affine subspace in $V$ containing $a$. Moreover,
\[
\lin(A_f)=\sum_{s\in\{0,1\}^n\setminus\{\theta_n\}} f(s)L_s,\qquad \Span(A_f)=S_f.
\]
The map $f\mapsto A_f $ is injective and has  the following further properties.
\begin{enumerate}
\item[(i)] The dual affine subspace satisfies  
\[
\tilde A_f(X_1,\dots,X_n)=A_{f^*}(\tilde X_1,\dots, \tilde X_n).
\]
\item[(ii)] Let $\sigma\in \permut_n$ and let the corresponding symmetry $\otimes_i V_i\to
\otimes_i V_{\sigma^{-1}(i)}$ be also denoted by $\sigma$. Then we have
\[
A_f(X_{\sigma(1)},\dots,X_{\sigma(n)})=\sigma^{-1}(A_{f\circ\sigma}(X_1,\dots,X_n)).
\]
\item[(iii)] Let $f_1\in \Fe_{n_1}$, $f_2\in \Fe_{n_2}$, $n_1+n_2=n$. Then
\[
S_{f_1\otimes f_2}(X_1,\dots,X_n)=S_{f_1}(X_1,\dots,X_{n_1})\otimes
S_{f_2}(X_{n_1+1},\dots, X_n)
\]
\end{enumerate}


%determined by 
%\[
%\tilde A_f=S_{\tilde A_f}\cap \{a\}^\sim,\qquad S_{\tilde A_f}= \bigoplus_{s\in \{0,1\}^n} f^*(s)\tilde L_s.
%\]

\end{lemma}

\begin{proof} It is clear from definition that $A_f$ is an affine subspace. Since
$f(\theta_n)=1$, the space $S_f$ always contains the subspace $L_0=L_{1,0}\otimes\dots\otimes
L_{n,0}=\mathbb R\{a\}$ and it is clear that $L_s\subseteq \{\tilde a\}^\perp$ for any
$s\ne \theta_n$. It follows that $a\in A_f$, so that $A_f\ne \emptyset$, and since $A_f\subseteq
\{\tilde a\}^\sim$, we see that  $A_f$ is proper and $\tilde
a\in \tilde A_f$.  The expressions for $\lin(A_f)$ and $\Span(A_f)$ are immediate from the definition and
\eqref{eq:LandS}. 

Injectivity of the map $f\mapsto A_f$ is clear from the fact that $L_s$, $s\in \{0,1\}$ is
an independent decomposition. To prove (i), we compute
using Lemma \ref{lemma:Lperp} and the fact that the subspaces form an independent
decomposition,
\begin{align*}
\Span(\tilde A_f)&=\lin(A_f)^\perp=\left(\sum_{s\in\{0,1\}^n\setminus\{0\}}
f(s)L_s\right)^\perp=
\bigwedge_{\substack{s\in\{0,1\}^n\\ s\ne 0, f(s)=1}}L_s^\perp=
\bigwedge_{\substack{s\in\{0,1\}^n\\ s\ne 0,
f(s)=1}}\left(\sum_{t\in\{0,1\}^n}(1-{\chi}_s(t))\tilde L_t\right)\\
&=\sum_{t\in\{0,1\}^n} \left(\bigwedge_{\substack{s\in \{0,1\}^n\\ s\ne 0, f(s)=1}}
(1-{\chi}_s(t))\tilde L_t\right)=\sum_{t\in \{0,1\}^n} f^*(t) \tilde L_t.
\end{align*}
To see the last equality, note that
\[
\bigwedge_{\substack{s\in \{0,1\}^n\\ s\ne 0, f(s)=1}}
(1-{\chi}_s(t))=\begin{dcases} 1 & \text{if } t=\theta_n\\ 1-f(t) & \text{if } t\ne \theta_n
\end{dcases} \ = f^*(t).
\]
To show (ii), compute
\begin{align*}
\sigma(S_f(X_{\sigma(1)},\dots,X_{\sigma(n)}))&=\sigma(\sum_{s} f(s)L_{\sigma(1),s_1}\otimes\dots \otimes
L_{\sigma(n),s_n})\\
&=\sum_s f(s) L_{1,s_{\sigma^{-1}(1)}}\otimes\dots\otimes
L_{n,s_{\sigma^{-1}(n)}}=S_{f\circ\sigma}(X_1,\dots,X_n).
\end{align*}
It folows that
\[
A_f(X_{\sigma(1)},\dots, X_{\sigma(n)})=S_f(X_{\sigma(1)},\dots, X_{\sigma(n)})\cap
\{\sigma^{-1}(\tilde a)\}^\sim=
\sigma^{-1}(A_{f\circ\sigma}(X_1,\dots,X_n)).
\]
The statement (iii) is easily seen from the definitions.
\end{proof}

Since all the affince subspaces  $A_f\subseteq V$ are proper, we may form the objects
\[
X_f=X_f(X_1,\dots, X_n):=(V,A_f(X_1,\dots,X_n))
\]
in $\Af$. The following properties follow easily from the above Lemma.

\begin{prop}\label{prop:Xf_const} Let $X_1,\dots,X_n$ be first order objects. 
The map $\Fe_n\ni f\mapsto X_f(X_1,\dots,X_n)$ is injective and we have 
\begin{enumerate}
\item[(i)] For the least and the largest element in $\Fe_n$, 
\[
X_{p_{[n]}}=\tilde X_1^*\otimes \dots\otimes \tilde X_n^*,\qquad
X_{1_n}=X_1\otimes\dots\otimes X_n,
\]

\item[(ii)] $X_f^*(X_1,\dots,X_n)=X_{f^*}(\tilde X_1,\dots,\tilde X_n)$,
\item[(iii)] $X_{f_1\otimes f_2}(X_1,\dots,X_n)=X_{f_1}(X_1,\dots, X_{n_1})\otimes
X_{f_2}(X_{n_1+1},\dots,X_n)$,
\item[(iv)]  the symmetry $\sigma\in \permut_n$ is an isomorphism $X_f(X_{\sigma(1)},\dots,
X_{\sigma(n)})\xrightarrow{\sigma} X_{f\circ\sigma}(X_1,\dots,X_n)$. 
\end{enumerate}
\end{prop}

It follows from the independence of $L_s$, $s\in \{0,1\}^n$, that  the subspaces $S_f$ form a
distributive sublatice in the lattice of subspaces of $V$ and we clearly have 
$f\le g$ if and only if $S_f\subseteq S_g$ and $S_{f\wedge g}=S_f\cap S_g$, $S_{f\vee
g}=S_f\vee S_g$. 
The following proposition shows the corresponding properties of $X_f$, in categorical
terms. We skip the easy proof.

\begin{prop} Let $f,g,h\in \Fe_n$. 
\begin{enumerate} 
\item[(i)] $f\le g$ if and only if $X_f\xrightarrow{id_V} X_g$ in $\Af$. 
\item[(ii)] Let $k\le f,g\le h$ then the following diagram is a pullback resp. pushout: 
\[
%\xymatrixcolsep{5pc}\xymatrixrowsep{3pc}
\xymatrix{
X_{f\wedge g}\ar[r]^{id_V}
\ar[d]_{id_V} & X_f\ar[d]^{id_V} \\
X_g \ar[r]_{id_V}& X_h
} \qquad 
\xymatrix{
X_{h}\ar[r]^{id_V}
\ar[d]_{id_V} & X_f\ar[d]^{id_V} \\
X_g \ar[r]_{id_V}& X_{f\vee g}
}
\]

\end{enumerate}

\end{prop}




Our goal is to show that the higher order objects are precisely those of the form
$Y=X_f(X_1,\dots,X_n)$ for some choice of the
first order objects $X_1,\dots, X_n$ and a function $f$ that belongs to a special subclass
 $\Te_n\subseteq \Fe_n$. The elements of this subclass will be called the {\em type
 functions},
 or {\em types}, and are defined as those functions in $\Fe_n$ that can be obtained by taking
 the constant function $1_1$ in each coordinate and then repeatedly applying duals and tensor
 products of such functions in any order. The set of indices for which the corresponding
 coordinate  was subjected to taking the dual an even number of times will be called the
{\em outputs} (of $f$) and denoted by $O=O_f$, indexes in $I=I_f:=[n]\setminus O_f$ will be
called {\em inputs}. The reason for this terminology will become clear later. It is easy to observe that if $f\in \Te_n$, then $O_{f^*}=I_f$ and $I_{f^*}=O_f$. Further,
for $f_1\in \Te_{n_1}$, $f_2\in \Te_{n_2}$, we have $O_{f_1\otimes f_2}=O_{f_1}\oplus
O_{f_2}$ and  $I_{f_1\otimes f_2}=I_{f_1}\oplus
I_{f_2}$, see \eqref{eq:disu} for the definition.

We have the following  description of the sets of type functions.

\begin{prop}\label{prop:type_min} The set $\Te_n$ is the smallest subset in $\Fe_n$ such
that:
\begin{enumerate}
\item $\Te_1=\Fe_1$,

\item For $n_1+n_2=n$, $\Te_{n_1}\otimes \Te_{n_2}\subseteq \Te_{n}$,
\item $\Te_n$  is invariant under permutations: if $f\in \Te_n$, then $f\circ \sigma\in
\Te_n$ for any $\sigma\in \permut_n$,
\item $\Te_n$  is invariant under complementation: if $f\in \Te_n$ then $f^*\in \Te_n$.

\end{enumerate}

\end{prop}


\begin{proof} It is clear by construction that any system of subsets $\{\Se_n\}_n$ with
these properties must contain the type functions and that $\{\Te_n\}_n$ itself has these
properties.

\end{proof}

  

Assume that  $Y$ is a higher order object constructed from a set of distinct first
order objects $Y_1,\dots, Y_n$, $Y_i=(V_{Y_i},\{\tilde a_{Y_i}\}^\sim)$.
%, we will write$Y\sim\{Y_1,\dots,Y_n\}$ in this case. 
Let us fix elements $a_{Y_i}\in A_{Y_i}$ and construct the conjugate objects $\tilde Y_i$. 
By compactness of $\FV$, we may assume (relabeling the objects if necessary) that the vector space of $Y$ has the form
\[
V_Y=V:=V_{1}\otimes \dots\otimes V_{n},
\]
where  $V_i$ is either $V_{Y_i}$ or $V_{Y_i}^*$, according to whether $Y_i$ was subjected
to taking duals an even or odd number of times. Similarly as for the type functions, the indices such that the first
case is true will be called the  outputs and the subset of outputs in $[n]$ will be denoted
by $O$, or $O_Y$, when we need to specify the object. The set $I=I_Y:=[n]\setminus O_Y$ is
the set of  inputs. 

\begin{theorem}\label{thm:boolean} Let $Y$ be a higher order object, constructed from first
order objects $Y_1,\dots,Y_n$. For $i\in [n]$, let 
$X_i=Y_i$ if $i\in O_Y$ and $X_i=\tilde Y_i$ for $i\in I_Y$. 
There is a unique function $f\in \Te_n$, with $O_f=O_Y$,  such that 
\[
Y= X_f=(V, A_f(X_1,\dots,X_n)).
\]
Conversely, let $X_1,\dots, X_n$  be first order objects  and let
$f\in \Te_n$. Then $Y=X_f$ is a higher order object with $O_Y=O_f$, with underlying first
order objects $Y_1,\dots, Y_n$, where $Y_i=X_i$ for $i\in O_f$ and $Y_i=\tilde X_i$ for
$i\in I_f$.  

\end{theorem}

\begin{proof} Since the map $f\mapsto X_f$ is injective, uniqueness is clear.  To show existence of this
function, we will proceed by induction on $n$. For $n=1$, the assertion is easily seen
to be true, since in this case, we we have either $Y=Y_1$ or $Y=Y_1^*$. In the first case, $O=[1]$,
$X_1=Y_1$ and 
\[
S_Y=V_Y=V_1=L_{1,0}\oplus L_{1,1}=1(0)L_{1,0}\oplus 1(1)L_{1,1},
\]
so in this case $f\in \Te_1$ is the constant 1. If $Y=Y_1^*$, we have $O=\emptyset$, $X_1=\tilde
Y_1$, and then
\[
S_Y=\mathbb R\{\tilde a_{Y_1}\}=L_{1,0}=1^*(0)L_{1,0}\oplus 1^*(1)L_{1,1},
\]
so that $f=1^*=p_{[1]}\in \Te_1$. It is clear that $_f=O_Y$ in both cases. 

Assume now that the assertion is true for
all $m<n$. By construction, $Y$ is either the tensor
product $Y=Z_1\otimes Z_2$, with
$Z_1$ constructed from $Y_{1},\dots, Y_{m}$ and $Z_2$ from $Y_{{m+1}},\dots,
Y_{n}$,
 or $Y$ is the dual of such a product. Let us assume the first case. It is clear that
 $O_{Z_1}\oplus O_{Z_2}=O_Y$, and similarly for $I$, so that the corresponding objects
 $X_1,\dots, X_m$ and $X_{m+1},\dots,X_n$  remain the same. By the induction 
assumption, there are functions $f_1\in \Te_m$ and $f_2\in \Te_{n-m}$ such that
$O_{f_1}=O_{Z_1}$, $O_{f_2}=O_{Z_2}$ and,  by Proposition \ref{prop:Xf_const}(iii), 
\[
Y=Z_1\otimes Z_2=X_{f_1}(X_1,\dots,X_m)\otimes X_{f_2}(X_{m+1},\dots,X_n)=X_{f_1\otimes
f_2}(X_1,\dots,X_n)
\]
This implies the assertion, with $f=f_1\otimes f_2\in \Te_n$ and $O_f=O_{f_1}\oplus
O_{f_2}=O_Y$. 
To finish the proof, it is now enough to observe that if the assertion holds for $Y$ then
it also  holds for $Y^*$. So assume that $Y=X_f(X_1,\dots,X_n)$ for some $f\in \Te_n$, 
then by Proposition \ref{prop:Xf_const}(ii), $Y^*=X_f^*=\tilde X_{f^*}(\tilde X_1,\dots,\tilde X_n)$. 
By the construction of conjugate objects, we have  $\tilde X_i=\tilde{\tilde Y}_i=Y_i$
if $i\in I_{Y}$ and $\tilde X_i=\tilde {Y}_i$ if $i\in O_Y$. Since by definition and the
assumption,
$O_{Y^*}=I_Y=I_f=O_{f^*}$, this proves the statement.

The converse is proved by a similar induction argument, using Proposition
\ref{prop:Xf_const}.

\end{proof}

Let us stress that in general, the objects $X_f$ depend on the choice of the elements
$a_{X_i}$. From the above proof, it is clear that  the  description in Theorem
\ref{thm:boolean} does not depend on the choice of the elements $a_{Y_i}\in A_{Y_i}$.
Furthermore, if all the first order objects are quantum, we have
$S_f(X_1,\dots,X_n)=S_f(\tilde X_1,\dots,\tilde X_n)$ and both $a$ and $\tilde a$ are 
some, possibly different,  multiple of the identity. The spaces $A_f(X_1,\dots,X_n)$ and $A_f(\tilde X_1,\dots,\tilde
X_n)$ differ only by this multiple. 

%\subsection{Type funtions and higher order objects}
%
%
%Let $\Te_n\subseteq \Fe_n$ be defined as the subset generated from the constant 
%function $1$ on $\{0,1\}$ by taking duals and tensor products. For example, we have
%\[
%\Te_1=\Fe_1=\{1,1^*\},\quad
%\Te_2=\{1\otimes 1, (1\otimes 1)^*, 1\otimes 1^*,1^*\otimes 1, (1^*\otimes 1)^*,
%(1\otimes 1^*)^*\},
%\]
%etc.  Elements of $\Te_n$ will be called {\em type functions}. Similarly as for the higher order
%objects, the indices in $[n]$ such that the corresponding
%component was subjected to taking the dual an even number of times will be called the
%outputs (of $f$) and denoted by $O=O_f$, indexes in $I=I_f:=[n]\setminus O_f$ will be
%called inputs. From the proof of Proposition \ref{prop:boolean}, it is easily seen that a
%higher order object is of the form $Y=X_f$ for a function $f\in \Te_n$ with the same outputs (and of
%course also inputs) as $Y$. We next show that the converse is true. 
%
%
%\begin{prop}\label{prop:type_hom}
%\end{prop}
%
%\begin{proof} As before, we will proceed by induction on $n$. For $n=1$, we only have the
%possibilities $f=1$ or $f=1^*$. In the first case, $O=[1]$ and we get
%\[
%S_f=1L_{1,0}\oplus 1L_{1,1}= V_{1},
%\]
%so that $X_f=(V_1,\{\tilde a_1\}^\sim)=X_1$. In the second case, $O=\emptyset$ and 
%\[
%S_f=1L_{1,0}=\mathbb R\{a_1\},
%\]
%so that $X_f=(V_1,\{a_1\})=\tilde X_1^*$. Assume next that the statement
%is true for all $m<n$ and assume that $f=f_1\otimes f_2$ for some $f_1\in \Fe_m$, $f_2\in
%\Fe_{n-m}$, then it is easily seen that $Y=Z_1\otimes Z_2$ for $Z_1=X_{f_1}(X_1,\dots,X_m)$ and
%$Z_2=X_{f_2}(X_{m+1},\dots,X_n)$. 
%By the induction assumption, $Z_1$ and $Z_2$ are higher order objects, with
%$O_{Z_i}=O_{f_i}$, it follows that $Y$ is a higher order object with $O_Y=O_{Z_1}\cup
%O_{Z_2}=O_{f_1}\cup O_{f_2}=O_f$.
%
%Finally, assume that the statement is true for $f\in \Fe_n$, we will show that it holds
%for $f^*$. By  Lemma \ref{lemma:Xf}, we see that $X_{f^*}(X_1,\dots,X_n)=X^*_f(\tilde
%X_1,\dots,\tilde X_n)$. By the assumption, $X_f$ is a higher order object with underlying
%first order objects $\tilde X_i$ for $i\in O_f$ and $\tilde{\tilde X}_i$ for $i\in I_f$. 
%Since $O_{f^*}=I_f$, the statement follows.
%
%
%
%\end{proof}
%

\section{The type functions}

The aim of this section is to gain some understanding into the structure and properties of
the set of types. We start by an important example.


\begin{exm}\label{exm:type_channels}
Let $T\subseteq [n]$. It is easily seen that the function  $p_T$ (see Appendix
\ref{sec:boolean}) is a type function, since we have
\[
p_T(s)=\Pi_{j\in T}(1-s_j)=\Pi_{j\in T} 1^*(s_j).
\]
By definition, $T$ is the set of inputs for $p_T$. Let $\Se=\{X_1,\dots, X_n\}$ be a set
of first order objects. Let $k=|T|$ and let $\sigma\in \permut_n$ bw such that
$p_T\circ \sigma=p_{[k]}\otimes 1_{n-k}$. By Proposition \ref{prop:Xf_const}, it follows that
we have the isomorphism  
\[
X_{p_T}(X_1,\dots,X_n)\xrightarrow{\sigma}X_{p_{[k]}\otimes 1_{n-k}}(X_{\sigma^{-1}(1)},\dots, X_{\sigma^{-1}(n)})=\tilde
X_T^*\otimes X_{[n]\setminus T},
\]
here $\tilde X_T=\otimes_{j\in T} \tilde X_j$ and $X_{[n]\setminus T}=\otimes_{j\in
[n]\setminus T} X_j$ are first order object by Lemma \ref{lemma:1ordertensor}.
It follows that $p_T$ describes replacement channels with set of input indices  $T$. By duality,
we obtain the isomorphisms
\[
X_{p_T^*}(X_1,\dots,X_n)=X_{p_T}^*(\tilde X_1,\dots,\tilde X_n)\xrightarrow{\sigma} (X_T^*\otimes \tilde
X_{[n]\setminus T})^*\xrightarrow{\rho}  [\tilde X_{[n]\setminus T},X_T],
\]
where $\rho$ denotes the symmetry given by the transposition in $\permut_2$. It follows
that $p^*_T=1-p_T+p_{[n]}$ corresponds to general channels with output indices $T$.

\end{exm}


\begin{lemma}\label{lemma:fh_setting} Let $f\in\Te_n$ and let $O_f=O$,  $I=I_f$. Then
\[
p_I\le f\le p_O^*.
\]

\end{lemma}

\begin{proof} This is obviously true for $n=1$. Indeed, in this case,
$\Te_1=\Fe_1=\{1=p_\emptyset,1^*=p_{[1]}\}$. If $f=1$, then $O=[1]$, $I=\emptyset$ and 
\[
p_I=p_{\emptyset}=1=p_O^*,
\]
the case  $f=1^*$ is obtained by taking complements. Assume that the assertion holds for
$m<n$. Let $f\in \Te_n$ and assume that  $f=g\otimes h$ for some  $g\in
\Te_m$, $h\in \Te_{n-m}$.  By the assumption,
\[
p_{I_g}\otimes p_{I_h}\le g\otimes h\le p^*_{O_g}\otimes p^*_{O_h}\le (p_{O_g}\otimes
p_{O_h})^*,
\]
the last inequality follows from Lemma \ref{lemma:fproduct}. With the decomposition
$[n]=[m][m+1,n]$, we have   
$O_f=O_g\oplus O_h$, $I_f=I_g\oplus I_h$, so that by Lemma \ref{lemma:PSPT}, 
$p_{O_f}=p_{O_g}\otimes p_{O_h}$ and
similarly for $p_{I_f}$. Now notice that any $f\in \Te_n$ is either of the form $(f\otimes
g)\circ \sigma$ or of the form $(f\otimes g)^*\circ \sigma$, for some permutation
$\sigma$. Since the inequality is easily seen to be preserved by
permutations, and reversed by duality which also swiches the input and output sets, the
assertion is proved.

\end{proof}


Combining this with Proposition \ref{prop:Xf_const}, we get the following result
(cf. cite). 

\begin{coro}\label{coro:setting} Let $Y$ be a higher order objects constructed from
first order objects $Y_1,\dots, Y_n$,  $O_Y=O$,
$I_Y=I$.  Then there are
$\sigma_1,\sigma_2\in \permut_n$ such that we have the  morphisms 
\[
Y_I^*\otimes Y_O\xrightarrow{\sigma_1} Y
\xrightarrow{\sigma_2} [Y_I, Y_O].
\]
 


\end{coro}



We also obtain  a simple  way to identify the output indices  of a type
function.

\begin{prop}\label{prop:fh_outputs} For $f\in \Te_n$, $j\in O_f$ if and only if
$f(e^j)=1$, here $e^j=\delta_{1,j}\dots\delta_{n,j}$.


\end{prop}


\begin{proof} Let $i\in O_f$, then by Lemma \ref{lemma:fh_setting}, $p_{I_f}(e^i)=1\le
f(e^i)$, so that $f(e^i)=1$. Conversely, if $f(e^i)=1$, then by the other inequality in
lemma \ref{lemma:fh_setting}, $p_{O_f}(e^i)=0$, whence $i\in O_f$.


\end{proof}




  We now look at some examples and non-examples.

\begin{exm}\label{exm:T2} The type functions for $n=2$ are given as (writing $\bar u=1-u$
for $u\in \{0,1\}$)
\[
1_2(s)=1,\quad p_{[2]}(s)=\bar s_1\bar s_2,\quad p_{\{1\}}(s)=\bar s_1, \quad 
p_{\{1\}}^*(s)= 1-\bar s_1+\bar
s_1\bar s_2,
\]
and functions  obtained from these by permutation, which gives 6 elements.
We have seen that  $\Fe_n$ has $2^{2^n-1}$ elements, so that $\Fe_2$ has 8
elements in total. The two of them that are not type functions are
\[
g(s)=1-\bar s_1-\bar s_2+2\bar s_1s_2,\qquad g^*(s)=\bar s_1+\bar s_2-\bar s_1\bar s_2.
\]
This can be checked directly from Lemma \ref{lemma:fh_setting} and
Proposition \ref{prop:fh_outputs}. Indeed, if $g\in \Te_2$, we would have $O_g=\emptyset$, so that
$p_{[2]}\le g\le p_\emptyset^*=p_{[2]}$, which is obviously not the case. Clearly, also the
complement $g^*\notin \Te_2$. Notice also that $g^*=p_{\{1\}}\vee p_{\{2\}}$, so that
$\Te_2$ is not a lattice. 

\end{exm}

Since $\Fe_2$ can be identified as a sublattice in $\Fe_n$ for
all $n\ge 2$ as $\Fe_2\ni f\mapsto f\otimes 1_{n-2}\in \Fe_n$, the above example shows
that  $\Te_n$, $n\ge 2$ is a  subposet in the distributive lattice 
$\Fe_n$ but itself not a lattice,  so that for $f_1,f_2\in
\Te_n$, none of $f_1\wedge f_2$ or $f_1\vee f_2$ has to be a type function.
Nevertheless, we have by the above results that all type functions with the same output
indices are contained in the interval $p_I\le f\le p_O^*$, which is a distributive
lattice. Elements of such an interval  will be called {\em subtypes}. It is easily seen
that for $n=2$ all subtypes are type functions, but it is not difficult to find a subtype
for $n=3$ which is not in $\Te_3$. The objects corresponding to
subtypes are not necessarily
higher order objects, but are embedded in  $[Y_I,Y_O]$ and contain the replacement
channels. If $f_1$ and $f_2$ have the same output set, then  $f_1\vee f_2$ and $f_1\wedge
f_2$ are subtypes. By Proposition \ref{prop:Xf_lattice}, the corresponding objects can be
obtained by pushouts resp. pullbacks of the higher order objects corresponding to $f_1$
and $f_2$.




\subsection{The poset $\Pe_f$}



Here we introduce the basic tools for describing and visualising the structure of type
functions. We will need the notions and results of Appendix \ref{app:functions, posets}.


By Theorem \ref{thm:basis}, any boolean function has a unique expression of the form
\[
f=\sum_{T\subseteq [n]} \hat f_Tp_T,
\]
where $\hat f$ is the M\"obius transform of $f$. Let $\mathcal P_f$ be the subposet in the
distributive lattice $2^n$,  of elements such that
$\hat f_T\ne 0$. We show that any type function $f\in \Te_n$ is fully determined by $\Pe_f$.  




****
 We say that a poset $\Pe$  is graded of rank
$k$ if every maximal chain in $\Pe$ has the same length equal to $k$ (recall that the length
of a chain is defined as the number of its elements -1). Equivalently,  there is
a unique rank function $\rho: \Pe\to \{0,1,\dots,k\}$ such that $\rho(S)=0$ if $S$ is a
minimal element of $\Pe$ and $\rho(T)=\rho(S)+1$ if $T$ covers $S$, that is, $S\le T$ and for any $R$ such that
$S\le R\le T$ we have $R=T$ or $R=S$. See [Stanley] for details.
****

\begin{prop}\label{prop:graded} Let $f\in \Te_n$, then $\mathcal P_f$ is a graded poset
with even rank $k\le n$ and rank function $\rho_f$. Moreover, we have
\[
f=\sum_{S\in \mathcal P_f}(-1)^{\rho_f(S)}p_S.
\]


\end{prop}

Then rank of $\Pe_f$ will be denoted by $r(f)$ and called the {\em rank} of $f$. Note that the
assertion means that for $f\in \Te_n$, 
\[
\hat f_S=\begin{dcases} (-1)^{\rho_f(S)},& \text{if } S\in \Pe_f\\
0, & \text{otherwise}.
\end{dcases}
\]


\begin{proof} 
We first note that the property in the statement is invariant under permutations and
complements. Assume  the statement holds for $f$ and let us take any $\sigma\in \permut_n$.
From Proposition \ref{prop:mobius} we have that  
$\widehat{f\circ \sigma}_S=\hat f_{\sigma(S)}$ so that $S\mapsto \sigma(S)$ is an
isomprphism  of  
$\mathcal P_{f\circ \sigma}$ onto $\mathcal P_{f}$. Hence if $\Pe_f$ is graded with rank
function $\rho_f$, then $\Pe_{f\circ\sigma}$ is graded with the same rank and has rank function
$\rho_{f\circ\sigma}=\rho_f\circ \sigma$. By the assumption we have 
\[
f\circ\sigma=\sum_{S\in \Pe_f}(-1)^{\rho_f(S)}p_S\circ\sigma=\sum_{S\in
\Pe_f}(-1)^{\rho_f(S)}p_{\sigma^{-1}(S)}=\sum_{S\in
\Pe_{f\circ\sigma}}(-1)^{\rho_f\circ \sigma(S)}p_{S}.
\]
For the complement, we have from the assumption and Proposition \ref{prop:mobius}(ii) that
\begin{equation}\label{eq:dual_rank}
f^*=(1-\hat f_\emptyset)1 -\sum_{\substack{S\in \mathcal P_f\\ \emptyset \ne S,
[n]\ne S}}
(-1)^{\rho_f(S)}p_S+(1- \hat f_{[n]})p_n.
\end{equation}
If $\emptyset \in \Pe_f$, then $\emptyset$ is the least element of $\Pe_f$, so that 
$\rho_f(\emptyset)=0$ and therefore $\hat f_\emptyset =
(-1)^0=1$. Similarly, if $[n]\in \Pe_f$, then $[n]$ is the largest element in $\Pe_f$,
hence it is the last element in any maximal chain. It follows that $\rho_f([n])=k$ and hence
$\hat f_{[n]}=(-1)^k=1$ (since $k$ is even). 
Therefore the equality \eqref{eq:dual_rank} implies that $\mathcal P_{f^*}$ differs from $\mathcal P_f$ only in the bottom  and
top elements:  $\emptyset \in \mathcal P_f$ iff  $\emptyset \notin \mathcal P_{f^*}$
and $p_n \in \mathcal P_f$ iff  $p_n \notin \mathcal P_{f^*}$. It follows that $\mathcal
P_{f^*}$ is graded as well, with rank  equal to $k-2$, $k$ or $k+2$, which in any case
is even. Furthermore,  this also implies 
that for all $S\in \Pe_f$, $S\notin \{\emptyset, [n]\}$, we
have  $\rho_{f^*}(S)=\rho_f(S)\pm 1$, according to whether $\emptyset$ was added or removed. The
statement now follows from \eqref{eq:dual_rank}. 

We now proceed by induction on $n$. For $n=1$, we have $2=\{\emptyset, [1]\}$ and
$\Te_1=\{1,1^*\}$. For $f=1$, $\mathcal P_f=\{\emptyset\}$ is a singleton, which 
is clearly a graded poset, with rank $k=0$ and trivial rank function $\rho_f$.  We have
\[
f = 1=p_\emptyset=(-1)^{\rho(\emptyset)}p_\emptyset.
\]
The statement for $f=1^*$ follows by duality. Assume that the statement is true for $m<n$ and let $f\in \Te_n$.
 By the first part of the proof,  we only need to prove
that the statement holds for $f=f_1\otimes f_2$, where $f_1\in \Te_{n_1}$, $f_2\in
\Te_{n_2}$, $n_1+n_2=n$.  By the induction
assumption, $\Pe_{f_i}$ is graded with even rank. We also
have using Proposition \ref{prop:mobius}
\[
f=f_1\otimes f_2=\sum_{S\subseteq [m], T\subseteq [n-m]} (\widehat {f_1})_S(\widehat
{f_2})_T p_S\otimes p_T=
\sum_{S\subseteq [m], T\subseteq [n-m]}(-1)^{\rho_{f_1}(S)+\rho_{f_2}(T)}p_{S\oplus T}.
\]
It follows that $\Pe_f\simeq \Pe_{f_1}\times \Pe_{f_2}$, where the direct product of posets $\Pe_f$ and
$\Pe_g$ is defined as the set of all pairs $(S,T)$, $S\in \Pe_f$, $T\in \Pe_g$, and
$(S,T)\le (S',T')$ iff $S\le S'$ and $T\le T'$.
By [Stanley], the direct product of graded posets 
is a graded poset with rank $r(f)=r(f_1)+r(f_2)$ and rank function
$\rho_f=\rho_{f_1}+\rho_{f_2}$.  This
proves the statement. 

\end{proof}

In the above proof, we also proved the following.

\begin{coro}\label{coro:Pf} Let $f\in \Te_n$, $g\in \Te_m$. Then
\begin{enumerate}
\item[(i)] For $\sigma\in \permut_n$, $S\mapsto \sigma(S)$ is an
isomprphism  of  $\mathcal P_{f\circ \sigma}$ onto $\mathcal P_{f}$.
\item[(ii)] $\Pe_{f^*}$ is obtained from from $\Pe_f$ by adding/removing the top and bottom
elements $\emptyset$ and $[n]$.
%$\emptyset \in \mathcal P_f$ iff  $\emptyset \notin \mathcal P_{f^*}$
%and $[n] \in \mathcal P_f$ iff  $[n] \notin \mathcal P_{f^*}$.
\item[(iii)] $\Pe_{f\otimes g}\simeq \Pe_f\times \Pe_g$.
\end{enumerate}


\end{coro}


We will visualise the poset $\Pe_f$  by its Hasse diagram, see Section \ref{sec:}. For simplification, we 
introduce {\em labels} for the elements of $\Pe_f$ in the following way. 
Let $f\in \Te_n$. For  $S\in \Pe_f$, put
\[
L_S:=\{i\in [n]\ : \ i\in S,\ \forall S'\subsetneq S, i\notin S'\},\qquad
L_\emptyset:=\{0\}\text{ (if $\emptyset\in \Pe_f$).}
\]
In other words, $i$ is a label for $S$ if $S$ is a minimal element in the subposet of
elements containing $i$ in  $\Pe_f$. We also put
\[
\Me_i:=\{S,\ i\in L_S\}.
\]
We also use the notation $L_{S,f}$ and $\Me_{i,f}$ if the function $f$ has to be
specified. It is clear from this definition that $\Me_i=\emptyset$ if and only if $i$ is
not contained in any label and  if $\Me_i$ is nonempty, it is an antichain in
$\Pe_f$.   Note also that we have
\[
\forall S\in \Pe_f,\quad S=\cup_{S'\subseteq S} L_{S'}\quad \text{ and }\cup\{L_S, \ S\in \Pe_f\}=\cup \Pe_f.
\]


In the Hasse diagram, we label any element  $S\in \Pe_f$ by  $L_S$, with no label if
$L_S=\emptyset$.

Examples (n=2,3,4).
\begin{exm}[$\Te_3$]
As we can see from Example \ref{exm:T2}, all elements in $\Te_2$ are chains. This is
also true for $n=3$. Indeed, up to a permutation that does not change the chain structure, 
any $f\in \Te_3$ is either a product of two elements $g\in \Te_2$ and $h\in \Te_1$,
or the dual of such a  product. Since $g$ must be a chain and $|\Pe_h|=1$, their product
must be a chain as well. Taking the dual of a chain only adds/removes the least/largest
elements, so the dual of a chain must be a chain as well.
\end{exm}



We next show that the input and output sets of $f\in \Te_n$ can be easily recognized from
the labels in $\Pe_f$. 

\begin{prop}\label{prop:pfinput} Let $f\in \Te_n$ and $i\in [n]$. Then
\begin{enumerate}
\item If $\Me_{i,f}\ne
\emptyset$, then all elements in $\Me_{i,f}$  have the same rank,  which will be
denoted by $r_f(i)$. If $\Me_{i,f}=\emptyset$, we put $r_f(i):=r(f)+1$. 
\item $i\in O_f$ if and only if $r_f(i)$ is odd.

\end{enumerate}
\end{prop}



\begin{proof} By Corollary \ref{coro:Pf}(i),  it is
quite clear that the two properties are preserved by permutations. We will show that they
are preserved by complementation. Observe first that $\Me_{i,f}=\emptyset$ if and only if
$\Me_{i,f^*}=\{[n]\}$, since $\Pe_{f^*}$ differs from $\Pe_f$ only up to adding/removing the
least element $\emptyset$ and the greatest element $[n]$. If $\Me_{i,f}$ is empty, then
$i\ne \cup\Pe_f$ and hence $p_S(e^i)=1$ for all $S\in
\Pe_f$. It follows that $f(e^i)=f(\theta_n)=1$, so that  $i\in O_f$  by Proposition
\ref{prop:pfinput}. We also see that $r_f(i)=r(f)+1$ is odd.
If $\Me_{i,f}=\{[n]\}$, then $r_f(i)=\rho_f([n])=r(f)$ by definition of the rank, hence
$r_{f}(i)$ is even. As we have seen in the first part of the proof, $i\in O_{f^*}=I_f$. 

Let us assume that $\Me_{i,f}$ is not equal to $\emptyset$ or $\{[n]\}$. Then we must have
$\Me_{i,f}=\Me_{i,f^*}$ and by the
proof of Proposition \ref{prop:graded} we have  
$\rho_{f^*}(S)=\rho_f(S)\pm 1$ for any $S$, depending only on the fact whether $\emptyset
\in \Pe_f$. This implies that the properties are preserved by complementation.  


We will now proceed by induction on $n$ as before. Both  assertions are quite trivial for $n=1$,
so assume the statements hold for $m<n$. It is enough to assume that
$f=g\otimes h$ for some $g\in \Te_m$ and $h\in \Te_{n-m}$. 
Suppose without loss of generality that $i\in [m]$, then all elements of $\Me_{i,f}$ have
the form $S\oplus T$, with $S\in \Me_{i,g}$ and  $T$ a minimal element in $\Pe_h$. 
 Since $\rho_h(T)=0$ for any minimal element $T\in \Pe_h$, we have
by the induction assumption
\[
\rho_f(S\oplus T)=\rho_g(S)+\rho_h(T)=\rho_g(S)= r_g(i).
\]
The statement (ii) follows from the fact that $i\in O_f$ if and only if $i\in O_g$.


\end{proof}

\begin{coro}\label{coro:free} We have $\cap{\Pe_f}\in I_f$, $[n]\setminus\cup{\Pe_f}\in O_f$.

\end{coro}

\begin{proof} If $i\in \cap\Pe_f$, then clearly $M_{f,i}$ is the set of minimal elements
in $\Pe_f$, so that $r_f(i)=0$ and $i\in I_f$ by Proposition \ref{prop:pfinput}. If
$i\notin S$ for any $S\in \Pe_f$, then $M_{f,i}=\emptyset$ and $r_f(i)=r(f)+1$ is odd.
Hence $i\in O_f$. 

\end{proof}

The elements in $I^F_{f}:=\cap\Pe_f$ resp. $O^F_{f}:=(\cup \Pe_f)^c$ will be called {\em
free inputs}  resp.
{\em free outputs}. It is easy to see that for any $f\in \Te_n$, there is some permutation
$\sigma\in \permut_n$ such that
\[
f\circ \sigma=p_{n_I}\otimes g\otimes 1_{n_O},
\]
where $\sigma([n_I])=I^F_f$, $\sigma([n-n_O+1,n])=O^F_f$ and $g\in \Te_{n-n_I-n_O}$ has no
free inputs or outputs.


\subsubsection{Chains and combs}

 We have seen that for some type functions the poset $\Pe_f$ is a chain, which is also a
 basic example of a graded poset. A chain in $2^n$ has the form  $\Pe=\{S_1\subsetneq S_2\subsetneq \dots \subsetneq
S_N\}$, $S_i\subseteq [n]$. Note that the length of the chain $\Pe$ is $N-1$.
It is clear that  $\Pe$ is graded with rank $N-1$
and rank function $\rho(S_i)=i-1$. 

\begin{prop}\label{prop:chains} For a chain   $\Pe=\{S_1\subsetneq S_2\subsetneq \dots \subsetneq
S_N\}$, the function  
\[
f=f_\Pe:=\sum_{i=1}^N (-1)^{i-1} p_{S_i}
\]
is a type function if and only if $N$ odd. In this case, we say that $f$ is a chain type.

\end{prop}

\begin{proof}
By Proposition \ref{prop:graded}, if $f\in \Te_n$, then the rank of $f$ must be even, so
that $N$ must be odd. 
We will show that the converse is true. We proceed by induction on $N$. For $N=1$, we have
$f=p_{S_1}\in \Te_n$. Assume that the statement holds for all odd numbers $M<N$ and let
$\Pe$ be a chain as above. Up to a permutation $\sigma\in \permut_n$, we may assume that
$S_j=[n_j]$ for some $0\le n_1<\dots <n_N\le n$. Then we have 
\[
f=p_{[n_1]}\sum_{i=1}^N (-1)^{i-1}p_{[n_1+1,n_i]}= p_{n_1}\otimes g\otimes 1_{n-n_N},
\]
where  $g=f_{\Pe'}\in
\Fe_{n_N-n_1}$ is the function for the chain $\Pe':=\{\emptyset\subsetneq [n_2-n_1]\subsetneq \dots
\subsetneq [n_N-n_1]\}$. Since $f$ is a type function if $g$ is, this shows that we may assume that 
the chain contains $\emptyset$ and $[n]$.  But then 
\[
f=1+\sum_{j=2}^{N-1} (-1)^{j-1}p_{S_j}+ p_{n} 
\]
and
\[
f^*=1-f+p_{n}=\sum_{j=1}^{N-2} (-1)^{j-1}p_{S_{j+1}},
\]
By the induction assumption $f^*\in \Te_n$, hence also $f=f^{**}\in
\Te_n$.
\end{proof}


Let $f\in \Te_n$ be a chain type and let $\Pe=\Pe_f=\{S_1\subsetneq \dots \subsetneq
S_N\}$ be the corresponding chain. Put $T_0:=S_1$ and $T_j:=S_{j+1}\setminus S_{j}$,
$j=1,\dots, N-1$, $T_{N}:=[n]\setminus S_N$.  It can be easily seen from Proposition \ref{prop:pfinput} that 
\begin{equation}\label{eq:chain_io}
I_f=\bigcup_{l=0}^{(N-1)/2}{T_{2j}}, \qquad O_f=\bigcup_{l=0}^{(N-1)/2}{T_{2j+1}}
\end{equation}
(note that $N$ must be odd). Clearly, $T_0=I_f^F$, $T_{N}=O_f^F$ are the sets of free inputs resp.
outputs. As before, up to a permutation, we may assume that  there are some $0\le
n_1<n_2<\dots<n_{N}\le n$ such that $S_j=[n_j]$, $j=1,\dots,N$, and $T_0=[n_1]$,
$T_j=[n_j+1, n_{j+1}]$, $j=1,\dots, N-1$ and $T_N=[n_N+1,n]$. We have  
\[
f=p_{n_1}\otimes g\otimes 1_{n-n_N}
\]
where $g\in \Te_{n_N-n_1}$ is a chain type with no free inputs or outputs. We will assume below that
$T_0=T_N=\emptyset$ and  show that such chains correspond to important higher order objects. 


\begin{prop}\label{prop:chains_combs}  Let $N$ be odd and let $\Pe=\{\emptyset= S_1\subsetneq \dots
\subsetneq S_N= [n]\}$. Let $f=f_\Pe$ be the corresponding chain type and let
$Y=X_f(X_1,\dots,X_n)$ for some first order objects $X_1,\dots, X_n$. Then for $N\ge 3$, $Y$ is an $(N-1)/2$-comb. 
More precisely, let $Y_1,\dots, Y_n$ be such that $Y_i=X_i$ for $i\in O_f$ and $Y_i=\tilde X_i$ for $i\in I_f$.
Then
\[
Y\simeq
[Y_{T_{N-1}},[[Y_{T_{N-2}},[[\dots,[[Y_{T_{\frac{N+1}2}},Y_{T_{\frac{N-1}2}}],Y_{T_{\frac{N-3}2}}]],\dots,Y_{T_2}]],Y_{T_1}]] 
 \]
 where we put $Y_T=\otimes_{j\in T} Y_j$, 
 and the isomorphism is given by a symmetry.

\end{prop}



\begin{proof} Let $Y_1,\dots,Y_n$ be as assumed, then  by \eqref{eq:chain_io}, 
\[
Y_{T_i}=\begin{dcases} \otimes_{j\in T_i}X_j,  & \text{ if } i\text{ is odd},\\
\otimes_{j\in T_i}\tilde X_i,& \text{ if }i\text{ is even}.
\end{dcases}
\]
As before, up to a permutation we may assume that $S_i=[n_i]$, $i=1,\dots, N$, where by
the assumptions
$0=n_1<n_2<\dots<n_N=n$, so that $T_1=[n_2]$ and $T_j=[n_j+1,n_{j+1}]$, $j=1,\dots, N-1$. 

Let $N=3$, then $f=1-p_{[n_2]}+p_{n}$, and we see from Example \ref{exm:type_channels}
that  $Y\simeq [Y_{T_2}, Y_{T_1}]$, where the isomorphism is a symmetry. 
Assume the assertion is true for  $N-2$.  As in the proof of Proposition \ref{prop:chains}, we see that 
\[
f^*=\sum_{i=1}^{N-2}(-1)^{i+1}p_{[n_{i+1}]}=p_{n_2}\otimes g\otimes 1_{n-n_{N-1}}
\]
where $g$ is the chain type for  a chain of intervals given by $0=m_1<m_2<\dots<m_{N-2}=m$ in $\Te_m$,
here $m_i=n_{i+1}-n_2$. By Proposition \ref{prop:Xf_const}, we see that 
\[
X_f(X_1,\dots,X_n)=X_{f^*}^*(\tilde X_1,\dots, \tilde X_n)\simeq (Y_{T_{N-1}}\otimes
\tilde X_g\otimes Y^*_{T_1})^*\simeq [Y_{T_{N-1}},[\tilde X_g,Y_{T_1}]]
\]
where $\tilde X_g=X_g(\tilde X_{n_2+1},\dots, \tilde X_{n_{N-1}})$ and the isomorphisms are
symmetries. Since $g$ satisfies the induction assumption, using that $\tilde {\tilde
X}_i=X_i$, we obtain 
\[
\tilde X_g\simeq
[Y_{T_{N-2}},[[\dots,[[Y_{T_{\frac{N+1}2}},Y_{T_{\frac{N-1}2}}],Y_{T_{\frac{N-3}2}}]],\dots,Y_{T_2}]].
\]
This implies the result.


\end{proof}

Combs, picture

Other examples



\subsection{Connecting chains: the causal product}


We now  introduce further operations of boolean functions. 
For a fixed decomposition $[n]=[n_1]\oplus[n_2]$ and functions
$f_1:\{0,1\}^{n_1}\to \{0,1\}$, $f_2:\{0,1\}^{n_2}\to \{0,1\}$, we define their {\em
causal product} as 
\[
f_1\vartriangleleft f_2:=f_1\otimes 1_{n_2}+p_{n_1}\otimes (f_2-1_{n_2}).
\]
For  $s^1\in \{0,1\}^{n_1}$ and $s^2\in \{0,1\}^{n_2}$, this function acts as
\begin{equation}\label{eq:causal_product}
(f_1\vtl f_2)(s^1s^2)= f_1(s^1)+p_{n_1}(s^1)(f_2(s^2)-1)=\begin{dcases} f_1(s^1), &
\text{ if } s^1\ne \theta_{n_1},\\
   f_2(s^2), & \text{ if } s^1=\theta_{n_1}.
   \end{dcases}
\end{equation}

\begin{remark} Causal: can be interpreted as ''$f_1$ before $f_2$'' (actually after).


\end{remark}

The following properties are immediate from \eqref{eq:causal_product}. 

\begin{lemma}\label{lemma:causal_product}
Let $f_1,g_1\in \Fe_{n_1}$, $f_2,g_2\in \Fe_{n_2}$. Then $f_1\vartriangleleft f_2\in \Fe_{n_1+n_2}$ and we
have 
\begin{enumerate}
\item[(i)] $(f_1\vtl f_2)^*=f_1^*\vtl f_2^*$,
\item[(ii)]$(f_1\vee g_1)\vtl (f_2\vee g_2)=(f_1\vtl f_2)\vee ( g_1\vtl g_2)=(f_1\vtl
g_2)\vee (g_1\vtl f_2)$,
\item[(iii)] $(f_1\wedge g_1)\vtl (f_2\wedge g_2)=(f_1\vtl f_2)\wedge ( g_1\vtl g_2)=(f_1\vtl
g_2)\wedge (g_1\vtl f_2)$.
\end{enumerate}
Moreover, for any $f_3\in \Fe_{n_3}$, and for the decomposition $[n]=[n_1]\oplus
[n_2]\oplus [n_3]$, we have 
\[
(f_1\vtl f_2)\vtl f_3=f_1\vtl (f_2\vtl f_3).
\]
\end{lemma}



We can also combine $f_1$ and $f_2$ in the opposite order:
\[
f_2\vtl f_1: =1_{n_1}\otimes f_2+(f_1-1_n)\otimes p_{n_2},
\]
so that
\begin{equation}\label{eq:causal_product_op}
(f_2\vtl f_1)(s^1s^2)=f_2(s^2)+p_{n_2}(s^2)(f_1(s^1)-1_{n_1})=\begin{dcases} f_2(s^2), & \text{ if }
s^2\ne \theta_{n_2},\\
   f_1(s^1), & \text{ if } s^2=\theta_{n_2}.
   \end{dcases}
\end{equation}
Of course, this product has similar properties as listed in the above lemma.
To avoid any confusion, we have to bear in mind the fixed decomposition $[n]=[n_1]\oplus
[n_2]$ and that for the concatenation $s=s^1s^2$, $f_i$ acts on $s^i$. 

\begin{lemma}\label{lemma:causal_tensor} In the situation as above, we have
\[
f_1\otimes f_2 = (f_1\vtr f_2)\wedge (f_2\vtr f_1).
\]

\end{lemma}


\begin{proof} This is again by straightforward computation from \eqref{eq:causal_product}
and \eqref{eq:causal_product_op}: let
$s^1\in \{0,1\}^{n_1}$, $s^2\in \{0,1\}^{n_2}$ and compute
\begin{align*}
(f_1\vtl f_2)\wedge (f_2\vtl
f_1)(s^1s^2)&=\left(f_1(s^1)+p_{n_1}(s^1)(f_2(s^2)-1)\right)\left(f_2(s^2)+p_{n_2}(s^2)(f_1(s^1)-1)\right)\\
=f_1(s^1)f_2(s^2),
\end{align*}
the last equality follows from the fact that $f_i(s^i)(1-f_i(s^i))=0$ (since $f_i(s^i)\in
\{0,1\}$) and the fact that $p_{n_1}$ is the least element in $\Fe_{n_1}$, so that
$p_{n_1}(s^1)(f_1(s^1)-1)=p_{n_1}(s^1)-p_{n_1}(s^1)=0$. 

\end{proof}

For the smallest and the largest element in $\Fe_n$, the causal product behaves as
follows.
\begin{lemma}\label{lemma:onechain_causal}
Let  $f\in \Fe_{n_1}$ and let $1_{n_2}, p_{n_2}\in \Fe_{n_2}$, we have
\[
f\vtl 1_{n_2}= f\otimes 1_{n_2}\le 1_{n_2}\vtl f =1-(1-\hat
f_\emptyset)p_{[n_2]}+\sum_{\emptyset \ne S\subseteq [n_1]} \hat f_S p_{S\oplus [n_2]}
\]
and
\[
p_{n_2} \vtl f=p_{n_2}\otimes f \le f\vtl p_{n_2}=\sum_{S\subsetneq [n]} \hat
f_Sp_S+(\hat f_{[n_1]}-1)p_{[n_1]}+p_{n_1+n_2}.
\]
In particular,
\[
(p_{n_1}\otimes 1_{n_2})^*=1_{n_1}\vtl p_{n_2}=1-p_{[n_1]}+p_{n_1+n_2}
\]
is the chain type for $\{\emptyset\subsetneq [n_1]\subsetneq [n_1+n_2]\}$.
\end{lemma}

\begin{proof}
Immediate from the definition of the causal product and Lemma \ref{lemma:causal_tensor}.

\end{proof}







Using the last part of Lemma \ref{lemma:causal_product},
for a decomposition $[n]=\oplus_i[n_i]$ and $f_i\in \Fe_{n_i}$,  we may define the function $f_1\vtl\dots \vtl f_k\in
\Fe_{n}$. Note that we have for $s=s^1\dots s^k$, 
\begin{align*}
(f_1\vtl \dots\vtl f_k)(s)&=f_1(s^1)+p_{n_1}(s^1)(f_2(s^2)-1)+\dots + p_{n_1}(s^1)\dots
p_{n_{k-1}}(s^{k-1})(f_k(s^k)-1)\\
&= \begin{dcases} f_1(s_1) & \text{ if } s^1\ne \theta_{n_1}\\
f_2(s^2) & \text{ if } s^1=\theta_{n_1}, s^2\ne \theta_{n_2}\\
\dots & \\
f_k(s^k) & \text{ if } s^1=\theta_{n_1},\dots,  s^{k-1}=\theta_{n_{k-1}}.
\end{dcases}
\end{align*}
For any permutation $\pi\in \permut_k$, we define  $f_{\pi^{-1}(1)}\vtl \dots \vtl
f_{\pi^{-1}(k)}\in \Fe_n$ in an obvious way.


\begin{prop}\label{prop:vtl_ordinal} Let $f\in \Te_{n}$, $g\in \Te_{m}$ and
consider the decomposition $[n+m]=[n]\oplus[m]$. Then  
\[
\Pe_{f\vtl g}=\begin{dcases}\bigl(\Pe_{f}\setminus \{[n]\}\bigr) \cup  \{[n]\} \cup \bigl([n]\oplus
(\Pe_{g}\setminus \{\emptyset\})\bigr)& \text{if } ([n]\in \Pe_{f})\, \&\, (\emptyset\in
\Pe_{g})\\  \ & \qquad \text{or } ([n]\notin \Pe_{f})\, \&\, (\emptyset\notin
\Pe_{g})\\[5pt]
\bigl(\Pe_{f}\setminus \{[n]\}\bigr) \cup \bigl([n]\oplus
(\Pe_{g}\setminus \{\emptyset\})\bigr) & \text{otherwise}.
\end{dcases}
\]
Similarly,
\[
\Pe_{g\vtl f}=\begin{dcases}\bigl(\emptyset \oplus (\Pe_{g})\setminus
\{[m]\})\bigr) \cup  \{\emptyset\oplus [m]\} \cup \bigl((\Pe_{f}\setminus
\{\emptyset\})\oplus [m]\bigr)& \text{if } ([m]\in \Pe_{g})\, \&\, (\emptyset\in
\Pe_{f})\\  \ & \quad \text{or } ([m]\notin \Pe_{g})\, \&\, (\emptyset\notin
\Pe_{f})\\[5pt]
\bigl(\emptyset\oplus (\Pe_{g}\setminus \{[m]\})\bigr) \cup \bigl((\Pe_{f}\setminus
\{\emptyset\})\oplus[m]\bigr) & \text{otherwise}.
\end{dcases}
\]

\end{prop}


\begin{proof} By definition of the causal product, we have  
\[
f\vtl g=\sum_{S\in \Pe_f\setminus\{[n]\}} \hat f_Sp_S+ (\hat f_{[n]}-1 + \hat
g_\emptyset)p_{[n]}+\sum_{T\in \Pe_g\setminus \{\emptyset\}} \hat g_T p_{[n]\oplus T}
\]
and 
\[
g\vtl f=\sum_{T\in \Pe_g\setminus\{[m]\}} \hat g_Tp_{\emptyset\oplus T}+ (\hat g_{[m]}-1 + \hat
f_\emptyset)p_{[m]}+\sum_{S\in \Pe_f\setminus \{\emptyset\}} \hat f_S p_{S\oplus [m]}.
\]
The terms in brackets can be equal to 1, -1, or 0, depending on whether $[n]\in \Pe_f$ and
$\emptyset\in \Pe_g$, resp. $[m]\in \Pe_g$ and $\emptyset 
\in \Pe_f$. The statement is now immediate.


\end{proof}



It is not clear that if $f$ and $g$ are type functions, then $f\vtl g$ or $g\vtl
f$ are type functions as well. Nevertheless, it can be seen from the above proposition
that if both $f$ and $g$ are chain types with chains of $N$ and $M$ elements,
respectively, then $f\vtl g$ is a chain type for a chain with $M+N\pm 1$
elements, similarly for $g\vtl f$. Note also that that this construction can be
interpreted as appending the two chain in the respective order. 
Our next result shows that if $f$ or $g$ is a chain type, we always obtain a type
function.




\begin{prop}\label{prop:append_chain_f}  Let $f\in \Te_{n_1}$ and let $\beta\in \Te_{n_2}$
be a chain type. Then both $f\vtl \beta$ and $\beta\vtl f$ are types, with outputs
$O=O_f\oplus O_\beta$ and inputs $I=I_f\oplus I_\beta$. 

\end{prop}

\begin{proof} Let  $\beta=\sum_{k=1}^{N}(-1)^{k-1}p_{T_k}$
for some odd $N$ and $T_1\subsetneq \dots \subsetneq T_N\subseteq [n_2]$. We will proceed by induction on $N$. Suppose $N=1$. If $T_1=\emptyset$,
then $\beta=1_{n_2}$ and we have by Lemma \ref{lemma:onechain_causal}
\[
f\vtl 1_{n_2}=f\otimes 1_{n_2}\in \Te_{n_1+n_2}
\]
and
\[
1_{n_2}\vtl f=(p_{n_2}\vtl f^*)^*=(f\otimes p_{n_2})^*\in \Te_{n_1+n_2}.
\]
Assume that  $T_1=[n_2]$, then $\beta=p_{n_2}$ and the assertion follows by duality. 
In general,  up to a permutation, we have $\beta=p_{m_1}\otimes
1_{m_2}=p_{m_1}\vtl 1_{m_2}$ for $m_1=|T_1|$, $m_1+m_2=n_2$. Then 
\[
\beta\vtl f=p_{m_1}\vtl (1_{m_2}\vtl f),\quad f\vtl \beta=(f\vtl p_{m_1})\vtl 1_{m_2} \in
\Te_{n_1+n_2},
\]
by the first part of the proof and Lemma \ref{lemma:causal_product}.

Assume next that the assertion holds for all odd numbers $M<N$. As before, up to a
permutation, we may assume that $T_k=[l_k]$ for some $l_1<\dots<l_{N}$. Let $\beta_1$ be the chain
type for the chain given by $l_1<\dots<l_{N-2}$ in $[l_{N-1}]$ and put
$\beta_2:=p_{[l_{N}-l_{N-1}]}$, the 1-element chain type in $\Te_{n_2-l_{N-1}}$. By
Proposition \ref{prop:append_chains}(c), we see
that $\beta=\beta_1\vtl\beta_2$, so that 
\[
\beta\vtl f=\beta_1\vtl(\beta_2\vtl f),\qquad f\vtl\beta=(f\vtl\beta_1)\vtl\beta_2
\]
are type functions, by the induction assumption. 


To prove the statement on the output and input indices, note that for any $i\in [n_1]\oplus [n_2]$, we have  $e^i_{n_1+n_2}=e^j_{n_1}\theta_{n_2}$ or
$e^i_{n_1+n_2}=\theta_{n_1}e^k_{n_2}$
for some $j\in [n_1]$, $k\in [n_2]$. Then   
\[
f\vtl\beta(e^i)=f(e^j_{n_1})\ \text{ or } f\vtl \beta(e^i)=\beta(e^k_{n_2}).
\]
The statement on input/output indices  follow from Lemma \ref{lemma:fh_setting}. The proof
for $\beta\vtl f$ is similar. 

\end{proof}


\subsection{The structure of type functions}

Our main result here is the  following structure theorem for the type functions.


\begin{theorem}\label{thm:structure}
Let  $f\in \Te_n$. Then there is a permutation $\rho\in \permut_n$, a decomposition
$[n]=\oplus_{i=1}^k[n_i]$, chain types 
$\beta_1\in \Te_{n_1}$,\dots, $\beta_k\in
\Te_{n_k}$ such that $O_f=\oplus_j O_{\beta_j}$, $I_f=\oplus_j I_{\beta_j}$, finite index sets $A$, $B$ and permutations $\pi_{a,b}\in
\permut_k$, $a\in A$, $b\in B$ such that 
\[
f=\bigvee_{a\in A}\bigwedge_{b\in B} (\beta_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta_{\pi^{-1}_{a,b}(k)})\circ \rho=\bigwedge_{b\in B}\bigvee_{a\in A}(\beta_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta_{\pi^{-1}_{a,b}(k)})\circ \rho.
\]
%Moreover, there is a decomposition $[k]=\oplus_{j=1}^{l} [k_j]$, permutations $\sigma_c^j\in
%\permut_{k_j}$ and $\lambda_d\in \permut_l$ such that either $\pi_{c,d}$, $c\in A$, $d\in
%B$, or $\pi_{d,c}$, $d\in A$, $c\in B$
%are block permutation of the form
%\[
%\rho_{\lambda_d}\circ(\oplus_j\sigma_c^j)
%\]
%(see Appendix \ref{sec:permut}).
%
\end{theorem}


\begin{proof} It is obvious that the condition is invariant under permutations. Since any element in $\Te_n$ for $n\le 3$ is a chain type, the statement clearly holds in
this case. 
Assume $f$ can be written in the given form, then
\[
f^*=\bigwedge _{a\in A}\bigvee_{b\in B} (\beta^*_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta^*_{\pi^{-1}_{a,b}(k)})\circ\rho=\bigvee_{b\in b}\bigwedge_{a\in A} (\beta^*_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta^*_{\pi^{-1}_{a,b}(k)})\circ\rho.
\]
Since $\beta_j^*$ is a chain type for each $j$, this proves the statement for $f^*$. 
%
%
%Since $\Fe_n$ is a distributive lattice, this can be rewritten as
%\[
%f^*=\bigvee_{a^*\in B^{|A|}}\bigwedge_{b^*\in A}(\beta^*_{\pi^{-1}_{a^*,b^*}(1)}\vtl \dots \vtl
%\beta^*_{\pi^{-1}_{a^*,b^*}(k)}),
%\]
%where for $a^*=(b_a)_{a\in A}$ and $b^*=a$, we have $\pi_{a^*,b^*}=\pi_{a,b_a}$. Since $\beta^*_j$ are chains in $[n_j]$,
%the assertion is true also for $f^*$.
 It is now enough to show this form for  $f=f_1\otimes f_2$, where 
$f_1\in \Te_m$, $f_2\in \Te_{n-m}$ satisfy the conditions, so that
\begin{align*}
f_1&=\bigvee_{a\in A}\bigwedge_{b\in B} (\beta^1_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta^1_{\pi^{-1}_{a,b}(k_1)})\circ\rho_1=\bigwedge_{b\in B}\bigvee_{a\in A} (\beta^1_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta^1_{\pi^{-1}_{a,b}(k_1)})\circ\rho_1,\\
f_2&=\bigvee_{c\in C}\bigwedge_{d\in D} (\beta^2_{\tau^{-1}_{c,d}(1)}\vtl \dots \vtl
\beta^2_{\tau^{-1}_{c,d}(k_2)})\circ\rho_2=\bigwedge_{d\in D} \bigvee_{c\in C}(\beta^2_{\tau^{-1}_{c,d}(1)}\vtl \dots \vtl
\beta^2_{\tau^{-1}_{c,d}(k_2)})\circ\rho_2
\end{align*}
for some chain types  $\beta^1_j\in \Te_{m_j}$, $[m]=\oplus^{k_1}_{j=1}[m_j]$, and $\beta^2_j\in \Te_{l_j}$,
$[n-m]=\oplus_{j=1}^{k_2}[l_j]$ and permutations $\pi_{a,b}\in \permut_{k_1}$, $\tau_{c,d}\in
\permut_{k_2}$, $\rho_1\in \permut_m$, $\rho_2\in \permut_{n-m}$.
Let 
\[
\beta^{a,b}_1:=\beta^1_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl
\beta^1_{\pi^{-1}_{a,b}(k_1)},\qquad \beta^{c,d}_2:= \beta^2_{\tau^{-1}_{c,d}(1)}\vtl \dots \vtl
\beta^2_{\tau^{-1}_{c,d}(k_2)}.
\]
Using the   properties of the tensor product (Lemma \ref{lemma:fproduct})ii), we get from
Lemma \ref{lemma:causal_tensor}
\[
\bigl(\bigvee_{a\in A}\bigwedge_{b\in B}\beta_1^{a,b}\bigr)\otimes \bigl(\bigvee_{c\in
C}\bigwedge_{d\in D}\beta_2^{c,d}\bigr)=\bigvee_{a,c}\bigwedge_{b,d}
(\beta_1^{a,b}\otimes \beta_2^{c,d})=\bigvee_{a,c}\bigwedge_{b,d}(\beta_1^{a,b}\vtl
\beta_2^{c,d})\wedge (\beta_2^{c,d}\vtl \beta_1^{a,b})
\]
On the other hand, using Lemma \ref{lemma:causal_product}, we
get
\begin{align*}
&\bigl(\bigwedge_{b\in B}\bigvee_{a\in A}\beta_1^{a,b}\bigr)\otimes \bigl(\bigwedge_{d\in D}\bigvee_{c\in
C}\beta_2^{c,d}\bigr)\\
&\quad =\left[\bigl(\bigwedge_{b\in B}\bigvee_{a\in A}\beta_1^{a,b}\bigr)\vtl \bigl(\bigwedge_{d\in D}\bigvee_{c\in
C}\beta_2^{c,d}\bigr)\right]\wedge \left[\bigl(\bigwedge_{d\in D}\bigvee_{c\in
C}\beta_2^{c,d}\bigr)\vtl\bigl(\bigwedge_{b\in B}\bigvee_{a\in A}\beta_1^{a,b}\bigr)
\right]\\
&= \bigl(\bigwedge_{b,d}\bigvee_{a,c} \beta_1^{a,b}\vtl \beta_2^{c,d}\bigr) \wedge
\bigl(\bigwedge_{b,d}\bigvee_{a,c} \beta_2^{c,d}\vtl \beta_1^{a,b}\bigr).
\end{align*}
We have the decomposition $[n]=\oplus_{j=1}^k[n_j]$, with $k=k_1+k_2$ and $n_j=m_j$,
$j=1,\dots, k_1$,  $n_j=l_{j-k_1}$, $j=k_1+1,\dots,k$, and chain types $\beta_j\in
\Te_{n_j}$, $\beta_j=\beta_j^1$ for $j=1,\dots,k_1$ and $\beta_j=\beta^2_{j-k_1}$ for
$j=k_1+1,\dots,k$. To get the permutation sets, let $A'=A\times C$, $B'=B\times D\times
\permut_2$ and define $\pi_{a',b'}$ in $\permut_k$ as the block permutation with respect to the
decomposition $[k]=[k_1]\oplus[k_2]$ (see Appendix \ref{sec:permut})
\[
\pi_{(a,c),(b,d,\lambda)}=\rho_\lambda\circ(\pi_{a,b}\oplus \tau_{c,d}).
\]
Finally, putting $\rho=\rho_1\otimes\rho_2$ finishes the proof.

\end{proof}


\begin{remark} Not always types, but subtypes.

\end{remark}






%\subsection{Further examples}
%
%To show further examples, we define the following basic chains. For even $n$, put
%\[
%\gamma_n(s):=\sum_{l=0}^n (-1)^lp_{[l]}(s)=1-\bar s_1+\bar s_1\bar s_2-\dots +\bar
%s_1\dots \bar s_n.
%\]
%The  corresponding sets of input and output indices  are
%\[
%I=\{2j, j=1,\dots n/2\},\qquad O=\{2j-1,\ j=1,\dots n/2\}.
%\]
%It is easily seen that the complement is
%\[
%\gamma^*:=p_{[1]}\otimes\gamma_{n-2}\otimes 1_1.
%\]
%If  $n$ is odd, we put
%\[
%\gamma_{n}:\gamma_{n-1}\otimes 1_1\qquad \gamma_n^*=p_{[1]}\otimes \gamma_{n-1}.
%\]
%In this case, the inputs and outputs are $I=\{2j, j=1,\dots (n-1)/2\},\qquad O=\{2j-1,\
%j=1,\dots (n-1)/2,n\}$, note that $n$ is a free output. 
%
%Let $n=4$. The only elements (up to permutations) in $\Te_4$ that are not chain types are
%the product of chains
%$f=p_{\{1\}}^*\otimes p_{\{1\}}^*$, $p_{\{1\}}\in \Te_2$:  
%\[
%f(s)=1-\bar s_1-\bar s_3+\bar s_1\bar s_2+\bar s_1\bar s_3+\bar s_3\bar s_4-\bar s_1\bar
%s_2\bar s_3 - \bar s_1\bar s_3\bar s_4+ \bar s_1\bar s_2\bar s_3 \bar s_4
%\]
%and its conjugate:
%\[
%f^*(s)=\bar s_1 +\bar s_3-\bar s_1\bar s_2-\bar s_1\bar s_3-\bar s_3\bar s_4+\bar s_1\bar
%s_2\bar s_3 + \bar s_1\bar s_3\bar s_4
%\]
%The
%corresponding posets are:
%
%picture
%
%As a product of chains, $\Pe_f$ is a distributive lattice, but it is obvious that
%$\Pe_{f^*}$ is not even a lattice.
%
%


%\subsubsection{The structure of $\Pe_f$ and $\Pe_f^0$}

It is clear that the chains in Theorem \ref{thm:structure} are not given uniquely, in
particular, some chains can be decomposed as a  concatenation of chains.
We will show that some choice of the chains $\beta_1,\dots,\beta_k$  can be found from the subposet
 of labelled elements in $\Pe_f$.





So let  $f\in \Te_n$ and let $\Pe_f^0\subseteq \Pe_f$ be the subposet consisting
of  all  labelled elements, that is
\[
\Pe_f^0=\{S\in \Pe_f, \ L_{S,f}\ne \emptyset \}.
\]
We will regard $\Pe_f^0$ as an abstract poset whose elements are labelled, forgetting that it is actually a subposet in $2^n$.  
In this sense, the elements of $\Pe_f^0$ will be denoted by $\mathsf{s}$, $\mathsf{t}$,
etc, with labels $L_{\mathsf{s}}\subseteq \{0\}\cup [n]$. The subset in $\Pe_f$ corresponding to
$\mathsf{s}\in \Pe_f^0$ will be denoted by the corresponding capital letter $S$ and is obtained as 
\[
S=\cup_{\mathsf{t}\le \mathsf{s}} L_{\mathsf{t}}.
\]
If $S=\emptyset$, the corresponding element will be denoted by $\mathsf{0}$ and in $[n]\in
\Pe_f^0$, the corresponding element will be denoted by $\mathsf{n}$.


****
For a finite poset $\Pe$, we denote by $\mathrm{Min}(\Pe)$ the set of minimal elements of
$\Pe$ and $\mathrm{Max}(\Pe)$ the set of maximal elements of $\Pe$.
****

The following lemma collects some basic properties of $\Pe_f^0$.


\begin{lemma}\label{lemma:p0_basic} Let $f\in \Te_n$.
\begin{enumerate}
\item[(i)] $\mathsf{s}\in \mathrm{Min}(\Pe_f^0)$ $\iff$ $S\in \mathrm{Min}(\Pe_f)$.
\item[(ii)] $\Pe_f^0$ is a chain $\iff$  $\Pe_f$ is a chain $\iff$  $\Pe_f^0\simeq \Pe_f$.

\item[(iii)] $\Pe^0_f$ has a largest element if and only if $f$ or $f^*$ has a free
output. In this case  the corresponding set is the largest element in $\Pe_f$. 

\end{enumerate}
\end{lemma}


\begin{proof} 
(i) Obvious. 

(ii) Assume that $\Pe^0_f$ is a chain, so that, in particular,
 $\Me_{i,f}$ is a singleton or empty for any $i\in [n]$. In the first case, we put
 $\Me_{i,f}=\{M_i\}$, by defintion of $\Me_{i,f}$, $M_i$ is contained in any $S\in \Pe_f$ containing $i$.
Since
$\Pe^0_f$ is a chain, we have $M_{i_1}\subseteq M_{i_2}\subseteq\dots\subseteq M_{i_k}$,
where $\{i_1,\dots,i_k\}=\cup \Pe_f$.  Let $S,T$ be two
elements in $\Pe_f$ and assume that $i\in S\setminus T$. For any $j\in T$, we have either
$M_i\subseteq M_j$ or $M_j\subseteq M_i$. In the first case, we get $i\in M_i\subseteq
M_j\subseteq T$, which is not possible. Hence $M_j\subseteq M_i$ for all $j\in T$. It
follows that $T=\cup_{j\in T} M_j\subseteq M_i\subseteq S$, so that $\Pe_f$ is a chain,
and it is clear that then $\Pe_f=\Pe_f^0$. 

If $\Pe_f$ is not a chain, then there are some type
functions
$f_1$, $f_2$ such that $f=f_1\otimes f_2$ or $f=(f_1\otimes f_2)^*$. Moreover, the ranks
of $f_1$ and $f_2$ are at least 2. It follows that both $\Pe_{f_1\otimes f_2}$ and
$\Pe_{(f_1\otimes f_2)^*}$ contain an element $S\oplus T$, where $S\in \Pe_{f_1}$, $T\in
\Pe_{f_2}$ but none of the two elements is minimal. Then there is some $S'\in \Pe_{f_1}$
and $T'\in \Pe_{f_2}$ such that $S'\oplus T$, $S\oplus T'\subsetneq S\oplus T$, so that no
element of $S\oplus T$ is a label. Hence
$S\oplus T\notin
\Pe_f^0$, so that $\Pe_f\ne \Pe_f^0$. 

(iii) The largest element  $T\in P^0_f$ must satisfy 
\[
\cup\Pe_f=\cup L_S \subseteq T\subseteq \cup \Pe_f.
\]
 If follows that $T=\cup\Pe_f $ is the largest element in $\Pe_f$. If $T\ne [n]$, then
 clearly, $f$ has some free outputs. If $T=[n]$, then for any index $i\in L_T$, we have by
 the proof of Proposition \ref{prop:pfinput} that
 $M_{i,f^*}=\emptyset$, so that $i$ is a free output. 




\end{proof}

We next describe the basic constructions on type functions in terms of $\Pe_f^0$.


\begin{lemma}\label{lemma:p0_constr} Let $f\in \Te_{n}$, $g\in \Te_{m}$. 
\begin{enumerate}
\item[(i)] If $S\in \Pe_f^0$ and $S\ne \emptyset$, $S\ne [n]$, then $S\in \Pe^0_{f^*}$. 
 $\emptyset \in \Pe^0_f$ $\iff$ $\emptyset \notin \Pe^0_{f^*}$ and  $[n]\in
\Pe^0_f$ $\iff$ $f^*$ has  free outputs.
\item[(ii)] $\Pe^0_{f\otimes g}=\{S\oplus T:\ S\in \Pe_f^0,\ T\in \Pe_g^0, \ S\in
\mathrm{Min}(\Pe_f) \text{ or } T\in \mathrm{Min}(\Pe_g)\}=: \Pe_f^0\oplus_{\min} \Pe_g^0$.

\item[(iii)] The causal product $f\vtl g$ is connected with the ordinal sum $\oplus_\le$ of
posets as follows:
\begin{enumerate}
\item[(a)] If $\Pe_f^0$ has no largest element, then
\[
\Pe^0_{f\vtl \beta}=\Pe_f^0\oplus_\le (\Pe_{\beta}^0\setminus \{\emptyset\})
\]
with same sets of labels.
\item[(b)] If $[n]\in \Pe_f^0$, then 
\[
\Pe^0_{f\vtl \beta}=(\Pe_{f}^0\setminus \{[n]\})\oplus_\le \Pe_g^0
\]
and for the minimal elements $S\in \mathrm{Min}(\Pe_g^0)$ the labels are
replaced by $L_{S,g}\cup L_{[n],f}$.
\item[(c)] If $\Pe_f^0$ has a largest element other than $[n]$ and $\emptyset \in \Pe_g$,
then 
\[
\Pe^0_{f\vtl \beta}=\Pe_f^0\oplus_\le (\Pe_{\beta}^0\setminus \{\emptyset\})
\]
and the free outputs of $f$ are added to the labels of elements in
$\mathrm{Min}(\Pe_g^0\setminus\{\emptyset\})$.
\item[(d)] If $\Pe_f^0$ has a largest element other than $[n]$ and $\emptyset \notin 
\Pe_g$, then 
\[
\Pe^0_{\beta\vtl f} =\Pe_f^0\oplus_\le \{[n]\}\oplus_\le \Pe_g^0
\]
where the label set $L_{[n]}$ consists of free outputs of $f$, all other labels remain the
same.

\end{enumerate}



\end{enumerate}


\end{lemma}


\begin{proof} (i) First two assertions are clear, the last equivalence was proved in the
proof of Lemma \ref{lemma:p0_basic}(iii).
The statement (ii) follows from the proof of Proposition \ref{prop:pfinput}. 

For (iii), we have by definition
\[
f\vtl g=\sum_{S\in \Pe_f\setminus\{[n]\}} \hat f_Sp_S+ (\hat f_{[n]}-1 + \hat
g_\emptyset)p_{[n]}+\sum_{T\in \Pe_g\setminus \{\emptyset\}} \hat g_T p_{[n]\oplus T}.
\]
It follows that $\Pe^0_{f\vtl g}$ is in any case a subposet in the ordinal sum 
\[
(\Pe_f^0\setminus \{[n]\})\oplus_\le\{[n]\}\oplus_\le (\Pe_{g}^0\setminus\{\emptyset\})
\]
and the only question is whether it contains $[n]$ or not. 
Under the assumption in (a), $[n]\notin \Pe_f^0$ and $f$ has no free outputs, so that even
if $[n]\in \Pe_{f\vtl g}$, it certaily has an empty label set, so that $[n]\notin
\Pe_{f\vtl g}^0$. Under the assumption in [(b)], $\Pe_{f\le g}$ contains $[n]$ only if
$\emptyset\in \Pe_g$, in any case, the labels of $[n]$ have to be added to the minimal
elements in $S$. Under the assumption in (c), $[n]\notin \Pe_{f\vtl g}$, but $f$ has some
free outputs that appear for the first time in $[n]\oplus S$, $S\in
\mathrm{Min}(\Pe_g^0\setminus \{\emptyset\})$. Finally, under the assumptions in (d)
$[n]\in \Pe_{f\vtl g}$ is labelled by the free outputs of $f$.

\end{proof}

We now strat to identify certain chains in $\Pe_f^0$.

\begin{lemma}\label{lemma:pf0_largest} Assume that $\Pe_f^0$ has a largest element.  Then
either $f$ is a chain type, or there is some $h\in \Te_m$ such that $\Pe_h^0$ has  no largest element,
and a chain type $\beta\in \Te_{n-m}$ such that up to a permutation, $f=h\vtl \beta$.

\end{lemma}



\begin{proof} Let $T$ be the largest element in $\Pe_f^0$. If $T=[n]$, then by Lemma
\ref{lemma:p0_constr}(i), $f^*$ has some free outputs. Hence, up to a permutation,
$f^*=h_1\otimes 1_{k_1}$ for some $h_1\in \Te_{n-k_1}$ with no free outputs. It follows that
$f=(h_1\otimes 1_{k_1})^*=(h_1\vtl 1_{k_1})^*=h_1^*\vtl p_{k_1}$. 

If $T\ne [n]$, then, since $T$
is also the largest element in $\Pe_f$, we see that $f$ has free outputs, so that (up to a
permutation)
$f=h_1\otimes 1_{k_1}=h_1\vtl 1_{\k_1}$, where $h_1\in \Te_{n-k_1}$ is a type function with no
free outputs. Clearly, $\Pe_{h_1}=\Pe_f$ and $\Pe_{h_1}^0=\Pe_f^0$, so that $T$ is the largest
element in $\Pe^0_{h_1}$, but this time $T=[n-k_1]$, so that we may use the first part of the
proof. We obtain that there is some $k_2$ and a type function  $h_2\in\Te_{n-k_1-k_2}$
with no free outputs such that 
\[
f=h_1\vtl 1_{k_1}=h_2^*\vtl p_{k_2}\vtl 1_{k_1}
\]
So far, we have written $f$ in the form $f=h\vtl \beta$, where $\beta$ is a chain type and
$h\in \Te_{n-k}$ for $k>0$ is such that $h^*$ has no free outputs. It follows that if
$\Pe_h^0$ has a largest element, then it cannot be equal to $[n-k]$. Hence $h$ must have
some free outputs, and we may proceed as above, replacing $f$ by $h$. Since $n$ is decreasing at each step, we
 either get to $n-k \le 3$, in which case $h$ must be a chain and therefore also $f=h\vtl
 \beta$ is a chain, or $\Pe^0_h$ has no largest element.


\end{proof}

%\begin{lemma}\label{lemma:pf0_smallest} Let $f\in \Te_n$ be such that either $f$ or $f^*$
%have a free input. Then either $f$ is a chain type, or there is some chain type $\beta\in
%\Te_k$ and some $h\in \Te_{n-k}$ such that $h$ nor $h^*$ has free inputs and $f=\beta\vtl
%h$. Equivalently, $\Pe_h^0$ and $\Pe_{h^*}^0$ have no smallest element other than,
%possibly,
%$\emptyset$.
%
%\end{lemma}
%
%
%\begin{proof} Assume  $\{S\}=\mathrm{Min}(\Pe_f^0)=\mathrm{Min}(P_f)$, then $S=\cap\Pe_f$ is the set
%of free inputs of $f$. If $S\ne \emptyset$, then up to a permutation, $f=p_k\otimes
%h=p_k\vtl h$,
%where $k=|S|$ and $h\in \Pe_{n-k}$ has no free inputs. On the other hand, if $f^*$ has a
%free input, then, similarly, $f^*=p_k\vtl g$ for some $g\in \Te_{n-k}$ with no free
%inputs, hence $f=(p_k\vtl g)^*=1_k\vtl g^*$. Repeating the process, we get the result
%after finitely many steps.
%
%
%\end{proof}
%


\begin{lemma}\label{lemma:p0_maximal} Let $T\in \mathrm{Max}(\Pe^0_f)$ and let
$T^{\downarrow,f}:=\{S\in \Pe_f, S\le T\}$. Put
\[
\bar \Pe_{T,f}:=\begin{dcases}  T^{\downarrow,f} & \text{if } \rho_f(T) \text{ is even}\\
  T^{\downarrow,f}\setminus T & \text{otherwise}.
  \end{dcases}
\]
Then there is some type function $g\in \Te_{|T|}$ and a permutation $\sigma\in \permut_{n}$
such that $\Pe_g=\sigma^{-1}(\bar \Pe_{T,f})$. 
\end{lemma}

\begin{proof} %Up to a permutation, we may assume that $T=[m]$ for some $m\le n$. 
%The assertion is rather trivial if $T$ is the largest element in $\Pe_f^0$, so we will assume
%that this is not the case.
%Let $m=|T|$ and let $\sigma\in \permut_n$ be a permutation such that $\sigma^{-1}(T)=[m]$. 
%We have $\Pe_{f\circ \sigma}=\sigma^{-1}(\Pe_f)$, and since $S\mapsto \sigma^{-1}(S)$ is
%an isomorphism of posets, we see that $[m]$ is a maximal element in $\Pe_{f\circ
%\sigma}^0$. We also clearly have $\bar \Pe_{[m],f\circ\sigma}=\sigma^{-1}(\bar
%\Pe_{T,f})$. By replacing $f$ be $f\circ \sigma$, we may assume that $T=[m]$, for some
%$m<n$.
%
We will proceed by induction on $n$. The assertion is trivial if $f$ is a chain type, so it
holds for $n\le 3$. So assume it holds for all $m<n$ and let $f\in \Te_n$. If
$f=f_1\otimes f_2$, then $T=T_1\oplus T_2$, where, say, $T_1\in \mathrm{Min}(\Pe_{f_1})$
and $T_2\in \mathrm{Max}(\Pe_{f_2}^0)$. It follows that 
\[
\bar \Pe_{T,f}=T_1\oplus \bar\Pe_{T_2,f_2}.
\]
By the induction assumption, there is some $\rho\in \permut_{n_2}$ such that
$\rho^{-1}(\bar \Pe_{T_2,f_2})=\Pe_h$ for some type function $h\in
\Te_{|T_2|}$. Put $\sigma= id_{n_1}\oplus \rho$, then
$\sigma^{-1}(\bar\Pe_{T,f})=T_1\oplus\Pe_h=\Pe_g$ with $g\in \Te_{|T|}$, $g=p_{T_1}\otimes h$.

Assume next that $f=(f_1\otimes f_2)^*$.  We may assume that 
 $T\ne \emptyset$ and $T\ne [n]$, since otherwise the assertion is rather trivial. We may
 also assume that $f$ has no free outputs, since otherwise $f=h\otimes 1$ and we may
 replace $f$ by $h$. Then $T\in \mathrm{Max}(\Pe^0_{f^*})$. 

Let $\rho_f(T)$ be even, so that the labels of $T$ correspond to inputs. Then
$\rho_{f^*}(T)$ is odd. Since $f^*$ has the desired property by the first part of the
proof, there is some $g\in \Te_{|T|}$ and $\sigma\in \permut_n$ such that
\[
\Pe_g=\sigma^{-1}(\bar \Pe_{T,f^*})=\sigma^{-1}(T^{\downarrow,f^*}).
\]
Since $g\in \Te_{|T|}$ and $\sigma^{-1}(T)\in \Pe_g$, we must have $\sigma^{-1}(T)=[|T|]$, 
so $\sigma^{-1}(T)\notin \Pe_{g^*}$ and $\emptyset \in \Pe_{g^*}$ if and only if
$\emptyset \notin \Pe_g$. It is now easy to see that $\Pe_{g^*}=\sigma^{-1}(\bar
\Pe_{T,f})$. The case when $\rho_f(T)$ is
odd is proved similarly.


\end{proof}


\begin{lemma}\label{lemma:struct} 
Assume that $f\in \Te_n$ and let  $S,T\in \mathrm{Max}(\Pe_f^0)$, $S\ne T$.  Then we have the following possibilities:
\begin{enumerate}
\item $\bar \Pe_{T,f}\cap \bar \Pe_{S,f}=\emptyset$,
\item $\bar \Pe_{T,f}\cap \bar \Pe_{S,f}=\{\emptyset\}$,
\item there is a chain $U_1\subsetneq \dots \subsetneq U_K\subseteq [n]$, type
functions $h_1\in \Te_{m_1}$, $h_2\in \Te_{m_2}$  and permutations $\sigma_1,\sigma_2\in
\permut_n$ such that
\begin{itemize}
\item $\bar \Pe_{S,f}\cap \bar \Pe_{T,f}=\{U_1,\dots, U_K\}$,
\item $\sigma^{-1}_1|_{U_K}=\sigma^{-1}_2|_{U_K}$,
\item $\Pe_{\beta\vtl h_1}=\sigma_1^{-1}(\bar \Pe_{S,f})$, $\Pe_{\beta\vtl
h_2}=\sigma_2^{-1}(\bar \Pe_{T,f})$, where $|S|-m_1=|T|-m_2=: k=|U_K|$ and
$\beta\in \Te_k$ is a chain type, with the corresponding chain $\sigma_1^{-1}(U_1)\subsetneq \dots
\subsetneq \sigma_1^{-1}(U_K)$ if $K$ is odd and $\sigma_1^{-1}(U_1)\subsetneq \dots
\subsetneq \sigma_1^{-1}(U_{K-1})$
if $K$ is even.
\end{itemize}

\end{enumerate}





\end{lemma}



\begin{proof} Note that $\Pe_f^0$ has no largest element, so that by Lemmas
\ref{lemma:p0_basic}(iii) and  \ref{lemma:p0_constr}(i), $[n]$ is not contained in
$\Pe_f^0$ nor $\Pe_{f^*}^0$. We will assume that $\emptyset \in \Pe_{f}$, in which case 
$\Pe_{f^*}^0=\Pe_f^0\setminus \{\emptyset\}$ and hence
$\mathrm{Max}(\Pe^0_f)=\mathrm{Max}(\Pe^0_{f^*})$. The sets $\bar \Pe_{T,f}$ and $\bar
\Pe_{T,f^*}$ differ only by addition/removal of the least element
$\emptyset$ and the largest element $T$, similarly for $S$. Hence 
$\bar\Pe_{T,f^*}\cap \bar \Pe_{S,f^*}=\left(\bar\Pe_{T,f}\cap \bar
\Pe_{S,f}\right)\setminus \{\emptyset\}$. The case  $\emptyset \in \Pe_{f^*}$
follows easily by duality. 


We will  proceed by induction on $n$. The smallest $n$ for which there is a function $f\in 
\Te_n$ such that $\Pe_f^0$ has no largest element is $n=4$, where the only possibilities,
up to permutations, 
are the functions $f=\gamma_2\otimes \gamma_2$ and its conjugate $f^*$, see Example
\ref{exm:motyl}.
Here the two maximal points in $\Pe_f^0$ and $\Pe_{f^*}^0$ are $S=\{1,2\}$
and $T=\{3,4\}$, and $\bar \Pe_{S,f}\cap \bar \Pe_{T,f}=\{\emptyset\}$, $\bar
\Pe_{S,f^*}\cap \bar \Pe_{T,f^*}=\emptyset$. 


Now assume that the statement holds for all $m<n$ and let $f\in \Te_n$. 
Let $U\in \bar \Pe_{S,f}\cap \bar \Pe_{T,f}$. 
By construction, we have either $f=f_1\otimes f_2$ or $f^*=(f_1\otimes f_2)$, for some
type functions $f_1\in \Te_{l_1}$ and $f_2\in \Te_{l_2}$. So assume that $f=f_1\otimes
f_2$, then $\Pe_f=\Pe_{f_1}\times \Pe_{f_2}$
and since $\emptyset \in \Pe_f$, we see
that both $\Pe_{f_1}$ and $\Pe_{f_2}$ must contain $\emptyset$. Since
\[
\Pe_f^0=\Pe_{f_1}^0\oplus_{\min} \Pe_{f_2}^0=\Pe_{f_1}^0 \cup \left(n_1+
\Pe_{f_2}^0\right)
\]
It follows that $T$ is
either a maximal element in $\Pe_{f_1}^0$ or $T=n_1+T'$ for some $T'$ in $\Pe_{f_2}^0$, similarly for $S$. Assume
that $T\in \mathrm{Max}(\Pe_{f_1}^0)$ and $S=n_1+S'$ for $S'\in \mathrm{Max}(\Pe_{f_2}^0)$, then the only
possibility is that $U=\emptyset$, so that
\[
\bar\Pe_{T,f}\cap \bar\Pe_{S,f}=\{\emptyset\}.
\]
If both $S,T\in \mathrm{Max}(\Pe_{f_1}^0)$, then necessarily $\bar \Pe_{T,f},\bar \Pe_{S,f}\subseteq
\Pe_{f_1}$, so that $\bar \Pe_{T,f}=\bar \Pe_{T,f_1}$ and $\bar \Pe_{S,f}=\bar
\Pe_{S,f_1}$.
This reduces the problem to a type function  with smaller $n$ and the assertion follows by
the induction assumption. The case $S,T\in n_1+\mathrm{Max}(\Pe_{f_2})$ is treated
similarly.

Next, assume that $f^*=f_1\otimes f_2$, so that $\Pe_{f^*}^0=\Pe_{f_1}^0\oplus_{\min}
\Pe_{f_2}^0$. Since $S,T\in \mathrm{Max}(\Pe_{f}^0)=\mathrm{Max}(\Pe_{f^*}^0)$, we see
that $S=S_1\oplus S_2$, $T=T_1\oplus T_2$, where we may assume some of the following cases:
\begin{enumerate}
\item $S_1\in \mathrm{Max}(\Pe_{f_1}^0)$, $S_2\in \mathrm{Min}(\Pe_{f_2})$ and $T_1\in
\mathrm{Min}(\Pe_{f_1})$, $T_2\in \mathrm{Max}(\Pe_{f_2}^0)$,
\item $S_1,T_1\in  \mathrm{Max}(\Pe_{f_1}^0)$, $S_2,T_2\in \mathrm{Min}(\Pe_{f_2})$,
\item $S_1,T_2\in \mathrm{Min}(\Pe_{f_1})$, $S_2,T_2\in  \mathrm{Max}(\Pe_{f_2}^0)$,
\end{enumerate}
note that we have $\emptyset \notin \Pe_{f^*}$, so that at least one of
$\mathrm{Min}(\Pe_{f_1})$ or $\mathrm{Min}(\Pe_{f_2})$ is different from $\{\emptyset\}$.
Since $U\in \Pe_f$, $U\subseteq S\cap T\subsetneq [n]$,  we have either $U=\emptyset$ or $U\in
\Pe_{f^*}$, in which case $U=U_1\oplus U_2$ for $U_1\in \Pe_{f_1}$, $U_2\in \Pe_{f_2}$. Assume $U\ne \emptyset$. 
In the case 1 above, we necessarily have 
$U=T_1\oplus S_2\in \mathrm{Min}(\Pe_{f^*})$. This gives us
\[
\bar\Pe_{T,f}\cap \bar\Pe_{S,f}=\{\emptyset, T_1\oplus S_2\},
\]
which is a two-element chain. It is easy to see that any element  $\bar \Pe_{S,f^*}$ must
contain $T_1\oplus S_2$. By Lemma \ref{lemma:p0_maximal} and its proof, there are $g_1\in
\Te_{|S|}$,
and $\tau_1\in \permut_n$ such that $\tau_1^{-1}(\bar
\Pe_{S,f})=\Pe_{g_1}$, and 
we have
$\tau_1^{-1}(\bar
\Pe_{S,f^*})=\Pe_{g_1^*}$. It follows that $\tau1^{-1}(T_1\oplus S_2)$ are free inputs of $g_1^*$.
Hence with $k:=|T_1|+ |S_2|$
there is some type function $h_1\in \Te_{|S|-k}$ and a permutation $\rho_1$ such that
$\rho_1^{-1}(\tau_1^{-1}(T_1\oplus S_2))=[k]$ and 
 $g_1^*\circ\rho_1=p_k\otimes h_1=p_k\vtl h_1$. It follows that $g_1\circ\rho_1=1_k\vtl
 h^*_1$ and 
 \[
\Pe_{1_k\vtl h_1^*}=\rho_1^{-1}(\Pe_{g_1})=(\tau_1\circ \rho_1)^{-1}(\bar \Pe_{S,f}).
 \]
Putting $\sigma_1=\tau_1\circ\rho_1$, we get $\sigma_1^{-1}(T_1\oplus S_2)=[k]$. In a
similar manner, we obtain a type function $h_2\in \Te_{|T|-k}$ and a permutation
$\sigma_2\in \permut_n$ such that $\sigma_2^{-1}(T_1\oplus S_2)=[k]$ and 
\[
\Pe_{1_k\vtl h_2^*}=\sigma_2^{-1}(\bar \Pe_{T,f}).
\]
 Since $1_k$ is a chain type
for the chain $U_1=\emptyset$, the statement follows. 

In the case 2,  we have $U_1\subseteq T_1,
S_1$ and $U_2\subseteq S_2,T_2$, so that  $U_2=S_2=T_2$. 
It follows that $\bar \Pe_{S,f^*}=\bar \Pe_{S_1,f_1}\oplus U_2$ and $\bar \Pe_{T,f^*}=\bar
\Pe_{T_1,f_1}\oplus U_2$, so that in this case,
\[
\bar\Pe_{S,f}\cap \bar\Pe_{T,f}=\{\emptyset\}\cup \left(\bar \Pe_{S_1,f_1}\cap \bar
\Pe_{T_1,f_1}\right)\oplus U_2.
\]
Since $f_1$ satisfies the induction assumption, there is a chain $V_1\subsetneq \dots
\subsetneq V_K$ such that
\[
\bar\Pe_{S_1,f_1}\cap \bar\Pe_{T_1,f_1}=\{V_1\subsetneq\dots\subsetneq V_L\}
\]
Moreover, there are functions $h_i\in \Te_{m_i}$, permutations $\tau_1,\tau_2\in
\permut_{l_1}$ and  a chain type
$\gamma \in \Te_{k'}$ with $k'=|V_K|=|S_1|-m_1=|T_1|-m_2$ such that
\[
\tau^{-1}_1(\bar \Pe_{S_1,f_1})=\Pe_{\gamma\vtl h_1},\qquad \tau_2^{-1}(\Pe_{\bar
T_1,f_1})=\Pe_{\gamma\vtl h_2}.
\]
It follows that
\[
\bar\Pe_{S,f}\cap \bar\Pe_{T,f}=\{\emptyset\subsetneq V_1\oplus U_2\subsetneq \dots
\subsetneq V_K\oplus U_2\}
\]
(note that we cannot have both $V_1$ and $U_2$ empty). Moreover, let $l=|U_2|$, let
$\rho\in \permut_{l_2}$ be such that $\rho^{-1}(U_2)=[l]$ and put
$\sigma_1:=\tau_1\oplus\rho$. We then have 
\[
\sigma^{-1}(\bar \Pe_{S,f^*})=\Pe_{\gamma\vtl h_1}\oplus [l]=\Pe_{(\gamma\vtl
h_1)\otimes p_l}=\Pe_{(p_l\vtl \gamma)\vtl h_1}
\]
and as in the proof of Lemma \ref{lemma:p0_maximal}, we obtain
\[
\sigma_1^{-1}(\bar \Pe_{S,f})=\Pe_{((p_1\vtl \gamma)\vtl h_1)^*}=\Pe_{(1_l\vtl
\gamma^*)\vtl h_1}.
\]
Similarly, with $\sigma_2=\tau_2\oplus \rho$, we get
\[
\sigma_2^{-1}(\bar \Pe_{T,f})=\Pe_{(1_l\vtl \gamma^*)\vtl h_2}.
\]
Assume that $L$ is odd, then the chain corresponding to $\gamma$ is $\tau_1^{-1}(V_1)\subsetneq
\dots\subsetneq \tau_1^{-1}(V_L)$, and the chain corresponding to $\beta=1_l\vtl \gamma^*$ is 
\[
\emptyset \subsetneq \tau_1^{-1}(V_1)\oplus [l]\subsetneq \dots
\subsetneq \tau_1^{-1}(V_{L-1})\oplus [l]=\emptyset \subsetneq \sigma_1^{-1}(V_1\oplus
U_2)\subsetneq \dots
\subsetneq \sigma_1^{-1}(V_{L-1}\oplus U_2),
\]
here we have used the fact that $\tau_1^{-1}(V_L)=[k']$. The case $L$ is even is obtained
similarly.


\end{proof}


%\end{lemma}



////


Let $f\in \Te_n$ and let $\Pe=\Pe_f$. Let $\Pe_f^0=\Pe^0\subseteq \Pe$ be the subposet of
elements $S\in \Pe_f$ such that either $S=\emptyset$ or $S\in M_{i,f}$ (so the set of all
elements in $\Pe$ with labels). Let $T$ be a maximal element in $\Pe^0$ and consider the
downset of $T$ in $\Pe$, that is,  $\Pe_T=\{S\in \Pe, S\subseteq T\}$. If $T$ is labeled by an
output index, that is, if the rank $\rho_f(T)$ is odd, then $\bar\Pe_T=\Pe_T\setminus
\{T\}$, otherwise we put $\bar \Pe_T=\Pe_T$. 


Assume that $T=[n_T]$ (we may always do that).
Then there is some $f_T\in \Te_{n_T}$ such that $\bar \Pe_T=\Pe_{f_T}$. 

We first show that $\bar \Pe_T$ is a graded poset with even rank. 







%\subsubsection{Some examples}
%
%
%\begin{exm}[Tensor products] Let $n=n_1+n_2+n_3+n_4$ and let $f_i\in \Te_{n_i}$, $i=1,\dots,4$. 
%Fix the concatenation decompositions $\{0,1\}^n\simeq \Pi_i\{0,1\}^{n_i}$,
%$\{0,1\}^{n_1+n_2}\simeq \{0,1\}^{n_1}\times \{0,1\}^{n_2}$, $\{0,1\}^{n_3+n_4}\simeq
%\{0,1\}^{n_3}\times \{0,1\}^{n_4}$. Using Lemmas \ref{lemma:causal_product} and \ref{lemma:causal_tensor}, we compute
%\[
%f_1\otimes f_2=(f_1\vtl f_2)\wedge (f_2\vtl f_1),\qquad 
%(f_1\otimes f_2)^*=(f^*_1\vtl f^*_2)\vee (f^*_2\vtl f^*_1).
%\]
%We then have using Lemmas \ref{lemma:fproduct} and \ref{lemma:causal_tensor},
%\begin{align*}
%(f_1\otimes f_2)\otimes f_3&=[(f_1\vtl f_2)\wedge (f_2\vtl f_1)]\otimes f_3=
%[(f_1\vtl f_2)\otimes f_3]\wedge [(f_2\vtl f_1)\otimes f_3]\\
%&=(f_1\vtl f_2 \vtl f_3)\wedge (f_3\vtl f_1\vtl f_2)\wedge (f_2\vtl f_1\vtl f_3)\wedge
%(f_3\vtl f_2\vtl f_1).
%\end{align*}
%On the other hand, note that we also have
%\begin{align*}
%f_1\otimes (f_2\otimes f_3)&=f_1\otimes [(f_2\vtl f_3)\wedge (f_3\vtl f_2)]\\
%&= (f_1\vtl f_2\vtl f_3)\wedge (f_2\vtl f_3\vtl f_1)\wedge (f_1\vtl f_3\vtl f_2)\wedge
%(f_3\vtl f_2\vtl f_1).
%\end{align*}
%Since the left hand sides are obviously equal, we obtain
%\[
%f_1\otimes f_2\otimes f_3=\bigwedge_{\pi\in \permut_3} (f_{\pi^{-1}(1)}\vtl
%f_{\pi^{-1}(2)}\vtl f_{\pi^{-1}(3)}),
%\]
%but we may restrict to permutations of the two kinds above:
%\[
%\{123,\ 213,\ 312,\ 321\},\quad \{123,\ 231,\ 132,\ 321\}.
%\]
%Similarly, for $f_1,\dots, f_k$ we get 
%\[
%f_1\otimes \dots \otimes f_k=\bigwedge_{\pi\in \permut_k} (f_{\pi^{-1}(1)}\vtl
%\dots \vtl f_{\pi^{-1}(k)}),
%\]
%but we may restrict to some subsets of permutations.
%
%We look at the case $k=4$. Then we have 
%\begin{align*}
%((f_1\otimes f_2)\otimes f_3)\otimes f_4&=(f_1\otimes (f_2\otimes f_3))\otimes f_4=
%f_1\otimes (f_2\otimes (f_3\otimes f_4))=f_1\otimes ((f_2\otimes f_3)\otimes f_4)\\
%&=(f_1\otimes f_2)\otimes (f_3\otimes f_4)
%\end{align*}
%For the first 4 equalities, we get the sets of permutations:
%\begin{align*}
%\{1234,\ 2134,\ 3124,\ 3214,\ 4123,\ 4213,\ 4312,\ 4321\}\\
%\{1234,\ 2314,\ 1324,\ 3214,\ 4123,\ 4231,\ 4132,\ 4321\}\\
%\{1234,\ 1324,\ 1423,\ 1432,\ 2341,\ 3241,\ 4231,\ 4321\}\\
%\{1234,\ 1342,\ 1243,\ 1432,\ 2341,\ 3421,\ 2431,\ 4321\}
%\end{align*}
%For the last one, we compute:
%\begin{align*}
%(f_1\otimes f_2)\otimes (f_3\otimes f_4)&=[(f_1\vtl f_2)\wedge (f_2\vtl f_1)]\otimes
%[(f_3\vtl f_4)\wedge (f_4\vtl f_3)]\\
%&=\biggl([(f_1\vtl f_2)\wedge (f_2\vtl f_1)]\vtl [(f_3\vtl f_4)\wedge (f_4\vtl
%f_3)]\biggr)\\ &\wedge \biggl([(f_3\vtl f_4)\wedge (f_4\vtl
%f_3)]\vtl [(f_1\vtl f_2)\wedge (f_2\vtl f_1)]\biggr)\\
%&=(f_1\vtl f_2\vtl f_3\vtl f_4)\wedge (f_2\vtl f_1\vtl f_4\vtl f_3)\\
%&\wedge (f_3\vtl f_4\vtl f_1\vtl f_2)\wedge (f_4\vtl f_3\vtl f_2\vtl f_1), 
%\end{align*}
%which gives us any of the sets
%\begin{align*}
%\{1234,\ 2143,\ 3412,\ 4321\}\\
%\{1243,\ 2134,\ 3421,\ 4312\},
%\end{align*}
%note these have only four elements!
%
%\end{exm}
%
%\begin{exm}\label{example:tensor3} In the situation of the previous example, we compute $(f_1\otimes
%f_2)^*\otimes f_3$. By the previous example, we have
%\[
%(f_1\otimes
%f_2)^*\otimes f_3= \bigl[(f^*_1\vtl f^*_2)\vee (f^*_2\vtl f^*_1)\bigr]\otimes f_3.
%\]
%This can be written as
%\begin{align*}
%(f_1\otimes
%f_2)^*\otimes f_3&=\bigl[(f^*_1\vtl f^*_2)\otimes f_3\bigr]\vee\bigl[ (f^*_2\vtl
%f^*_1)\otimes f_3\bigr]\\
%&=\biggl[\bigl(f^*_1\vtl f^*_2\vtl f_3\bigl)\wedge \bigl(f_3\vtl f_1^*\vtl
%f_2^*\bigr)\biggr]\vee \biggl[\bigl(f^*_2\vtl f^*_1\vtl f_3\bigl)\wedge \bigl(f_3\vtl
%f_2^*\vtl f_1^*\bigr)\biggr]
%\end{align*}
%but also as 
%\begin{align*}
%(f_1\otimes
%f_2)^*\otimes f_3&=\biggl[\bigl[(f^*_1\vtl f^*_2)\vee (f^*_2\vtl f^*_1)\bigr]\vtl
%f_3\biggr]\wedge \biggl[f_3\vtl \bigl[(f^*_1\vtl f^*_2)\vee (f^*_2\vtl
%f^*_1)\bigr]\biggr]\\
%&=\biggl[\bigl(f^*_1\vtl f^*_2\vtl f_3\bigr)\vee \bigl(f^*_2\vtl f^*_1\vtl
%f_3\bigr)\biggr]\wedge \biggl[\bigl(f_3\vtl f^*_1\vtl f^*_2\bigr)\vee \bigl(f_3\vtl f^*_2\vtl
%f^*_1\bigr)\biggr]
%\end{align*}
%
%
%\end{exm}
%
%
%\begin{exm}\label{example:tensor34} Let us next compute $(f_1\otimes f_1)^*\otimes (f_3\otimes f_4)$. 
%There are several possibilities how to get this: either plug $(f_3\otimes f_4)$ instead of
%$f_3$ into the two forms in the above example, or compute as tensoring the two forms with
%$f_4$. That is,
%\begin{align*}
%(f_1\otimes
%f_2)^*\otimes f_3\otimes f_4&=\biggl[\bigl(f^*_1\vtl f^*_2\vtl (f_3\otimes
%f_4)\bigl)\wedge \bigl((f_3\otimes f_4)\vtl f_1^*\vtl
%f_2^*\bigr)\biggr]\\  &\vee \biggl[\bigl(f^*_2\vtl f^*_1\vtl (f_3\otimes f_4)\bigl)\wedge
%\bigl((f_3\otimes f_4)\vtl
%f_2^*\vtl f_1^*\bigr)\biggr]\\
%&= \biggl[(f^*_1\vtl f^*_2\vtl f_3\vtl f_4)\wedge (f^*_1\vtl f^*_2\vtl 
%f_4\vtl f_3)\\&\qquad\wedge (f_3\vtl f_4\vtl f_1^*\vtl f_2^*)\wedge (f_4\vtl f_3\vtl
%f_1^*\vtl f_2^*)\biggr]\\
%&\vee\biggl[(f^*_2\vtl f^*_1\vtl f_3\vtl f_4)\wedge (f^*_2\vtl f^*_1\vtl 
%f_4\vtl f_3)\\&\qquad\wedge (f_3\vtl f_4\vtl f_2^*\vtl f_1^*)\wedge (f_4\vtl f_3\vtl
%f_2^*\vtl f_1^*)\biggr]
%\end{align*}
%or
%\begin{align*}
%(f_1\otimes
%f_2)^*\otimes f_3\otimes f_4&=\biggl[\bigl[(f^*_1\vtl f^*_2\vtl f_3)\vee (f^*_2\vtl f^*_1\vtl
%f_3)\bigr]\wedge \bigl[(f_3\vtl f^*_1\vtl f^*_2)\vee (f_3\vtl f^*_2\vtl
%f^*_1)\bigr]\biggr]\otimes f_4\\
%&=\biggl[\biggl[\bigl[(\dots)\vee (\dots)\bigr]\wedge
%\bigl[(\dots)\vee(\dots)\bigr]\biggr]\vtl f_4 \biggr]\\
%&\qquad \qquad \wedge \biggl[f_4\vtl\biggl[\bigl[(\dots)\vee (\dots)\bigr]\wedge
%\bigl[(\dots)\vee(\dots)\bigr]\biggr]\\
%&=\biggl[(f^*_1\vtl f^*_2\vtl f_3\vtl f_4)\vee (f^*_2\vtl f^*_1\vtl
%f_3\vtl f_4)\biggr]\\
%&\wedge \biggl[(f_3\vtl f^*_1\vtl f^*_2\vtl f_4)\vee (f_3\vtl f^*_2\vtl
%f^*_1\vtl f_4)\biggr]\\
%&\wedge \biggl[(f_4\vtl f^*_1\vtl f^*_2\vtl f_3)\vee (f_4\vtl f^*_2\vtl f^*_1\vtl
%f_3)\biggr]\\
%&\wedge \biggl[(f_4\vtl f_3\vtl f^*_1\vtl f^*_2)\vee (f_4\vtl f_3\vtl f^*_2\vtl
%f^*_1)\biggr]
%\end{align*}
%
%\end{exm}
%
%\begin{exm} Here we compute $(f_1\otimes f_2)^*\otimes (f_3\otimes f_4)^*$. We have
%\begin{align*}
%(f_1\otimes f_2)^*\otimes (f_3\otimes f_4)^*&= \bigl[(f_1^*\vtl f^*_2)\vee (f_2^*\vtl
%f_1^*\bigr]\otimes \bigl[(f_3^*\vtl f^*_4)\vee (f_4^*\vtl
%f_3^*)\bigr]\\
%&= \bigl[(f_1^*\vtl f^*_2)\otimes (f_3^*\vtl f^*_4)\bigr]\vee \bigl[(f_1^*\vtl
%f^*_2)\otimes (f_4^*\vtl f^*_3)\bigr]\\
%&\quad \vee \bigl[(f_2^*\vtl f^*_1)\otimes (f_3^*\vtl
%f^*_4)\bigr]\vee \bigl[(f_2^*\vtl f^*_1)\otimes (f_4^*\vtl f^*_3)\bigr]\\
%&=[1234 \wedge 3412]\vee [1243\wedge 4312] \vee [2134\wedge 3421]\vee [2143\wedge 4321]
%\end{align*}
%but also
%\begin{align*}
%(f_1\otimes f_2)^*\otimes (f_3\otimes f_4)^*&= \biggl[\bigl[(f_1^*\vtl f^*_2)\vee (f_2^*\vtl
%f_1^*)\bigr]\vtl  \bigl[(f_3^*\vtl f^*_4)\vee (f_4^*\vtl
%f_3^*)\bigr]\biggr]\\
%&\quad\wedge\biggl[\bigl[(f_3^*\vtl f^*_4)\vee (f_4^*\vtl
%f_3^*)\bigr]\vtl  \bigl[(f_1^*\vtl f^*_2)\vee (f_2^*\vtl
%f_1^*)\bigr]\biggr] \\
%&= [1234\vee 2143]\wedge [3412\vee 4321]
%\end{align*}
%
%
%
%
%\end{exm}
%
%
%///
%
%Examples??
%
%Let $f$ be a function of the form as in Theorem \ref{thm:structure}. Since all the chains
%$\beta_{a,b}:=\beta_{\pi^{-1}_{a,b}(1)}\vtl \dots \vtl \beta_{\pi^{-1}_{a,b}(k)}\circ
%\rho_{a,b}$ in the
%decomposition have the same input and  output indices, they must satsfy the inequality
%$p_{I}\le \beta_{a,b} \le p_{O}^*$. But then the same is true for $f$.
%It follows that although we do not know whether $f$ is a type function, the corresponding
%object $X_f$ is always included in a set of channels.
%
%In particular, in the quantum case, each $X_{\beta_{a,b}}$ describes quantum combs  obtained by
%connecting combs described by  $X_{\beta_1},\dots, X_{\beta_k}$, in different orders
%according to $\pi_{a,b}$. ... NOT QUITE LIKE THIS!!!
%
%
%
%
%
%
%
%
%
%
%-- Quantum combs
%

\appendix


\section{Permutations, binary strings and boolean functions}


For $m\le n\in \mathbb N$, we will denote the corresponding interval $\{m,m+1,\dots,n\}$ by
$[m,n]$. For $m=1$, we will simplify to  $[n]:=[1,n]$. Let $\permut_n$ denote the set of all permutations of $[n]$.


\subsection{Block permutations}
\label{sec:permut}


 For $n_1,n_2\in \mathbb N$, $n_1+n_2=n$, 
we will denote by $[n]=[n_1]\oplus [n_2]$ the decomposition of $[n]$ as a concatenation of two 
intervals
\[
[n]=[n_1][n_1+1,n_1+n_2].
\]
Similarly, for $n=\sum_{j=1}^kn_j$, we have the decomposition
\[
[n]=\oplus_{j=1}^k[n_j]=[m_1,m_1+n_1][m_2,m_2+n_2]\dots[m_k,m_k+n_k],
\]
where $m_j:=\sum_{l=1}^{j-1} n_j$ (so $m_1=0$). Note that the order of $n_1,\dots, n_k$ in
this decomposition is
fixed. 

We have two kinds of special permutations related to the above decomposition. For
$\sigma_j\in \permut_{n_j}$, we denote by $\oplus_j \sigma_j\in \permut_n$ the permutation that acts as
\[
m_j+l\mapsto m_j+\sigma_j(l),\qquad l=1,\dots,n_j,\ j=1,\dots, k. 
\]
On the other hand, we have for any $\lambda\in \permut_k$ a unique permutation
$\rho_\lambda\in\permut_n$  such that $\rho_\lambda^{-1}$ acts as
\[
[m_1,m_1+n_1][m_2,m_2+n_2]...[m_k,m_k+n_k]\mapsto
[m_{\lambda(1)}+n_{\lambda(1)}][m_{\lambda(2)}+n_{\lambda(2)}]\dots[m_{\lambda(k)}+n_{\lambda(k)}]
\]
Note that we have
\[
\rho_\lambda\circ(\oplus_j\sigma_j)=(\oplus_j \sigma_{\lambda(j)})\circ\rho_\lambda.
\]
(These permutations  come from the operadic structure on the set of
all permutations $\permut_*$.)


\subsection{Binary strings}

A binary string of length $n$ is a sequence  $s=s_1\dots s_n$, where $s_i\in
\{0,1\}$. Such a string can be interpreted as an element $\{0,1\}^n$, but also as a 
map $[n]\to \{0,1\}$, or a subset in  $[n]:=\{1,\dots,n\}$. It will be convenient to use
all these interpretations, but we will distinguish between them. The strings in
$\{0,1\}^n$ will be denoted by small letters, whereas the corresponding subsets of $[n]$
will be denoted by the corresponding capital letters. More specifically, for $s\in \{0,1\}^n$ and 
$T\subseteq [n]$, we denote
\begin{equation}\label{eq:string_subset}
S:=\{i\in [n],\ s_i=0\},\qquad t:=t_1\dots t_n,\ t_j=0 \iff j\in T.
\end{equation}
As usual, the set of all subsets of $[n]$ will be denoted by $2^n$. 
%We will also use the notation $2:=2^1=\{0,1\}$. 
With the inclusion ordering and complementation $S^c:=[n]\setminus S$,
$2^n$ is a boolean algebra, with the smallest element $\emptyset$ and largest element
$[n]$.  

The group $\permut_n$ has an obvious action on $\{0,1\}^n$. Indeed,
 for a string $s$  interpreted as a map $[n]\to 2$, we may define the action of
$\sigma\in \permut_n$ by precomposition as
\[
\sigma(s):=s\circ\sigma^{-1}=s_{\sigma^{-1}(1)}\dots s_{\sigma^{-1}(n)}.
\]
Note that in this way we have $\rho(\sigma(s))=(\rho\circ \sigma)(s)$. For a decomposition
$[n]=\oplus_{j=1}^k[n_j]$, we have a corresponding decomposition of
any string $s\in \{0,1\}^n$ as a concatenation of strings
\[
s=s^1\dots s^k,\qquad s^j\in \{0,1\}^{n_j}.
\]
For permutations $\sigma_j\in \permut_{n_j}$ and  $\lambda\in
\permut_k$, we have
\[
\rho_\lambda\circ(\oplus_j\sigma_j)(s^1\dots s^k)=\rho_\lambda(\sigma_1(s^1)\dots
\sigma_k(s^k))=\sigma_{\lambda(1)}(s^{\lambda(1)})\sigma_{\lambda(2)}(s^{\lambda(2)})\dots
\sigma_{\lambda(k)}(s^{\lambda(k)}).
\]





\subsection{Boolean functions and the  M\"obius transform}
\label{sec:boolean}

A function $f:\{0,1\}^n\to \{0,1\}$ is called a boolean function. 
The set of boolean functions, with pointwise ordering and complementation given by the
negation $\bar f=1-f$,  is a boolean algebra that can be identified with $2^{2^n}$.
We will denote the maximal element (the constant 1 function) by $1_n$. Similarly,
we denote the constant zero function by $0_n$.  For boolean
functions $f,g$, the pointwise minima and maxima will be denoted by $f\wedge g$ and $f\vee
g$. It is easily seen that we have
\begin{equation}\label{eq:wedgevee_fun}
f\vee g= f+g-fg,\qquad f\wedge g=fg,
\end{equation}
all the operations are pointwise. We now introduce and important example. 


\begin{exm}\label{ex:pS}
For $S\subseteq [n]$, we define
\[
p_S(t)=\Pi_{j\in S}(1-t_j),\qquad t\in \{0,1\}^n.
\]
That is, $p_S(t)=1$ if and only if $S\subseteq T$. In particular,
$p_\emptyset=1_n$ and $p_{[n]}$ is the characteristic function of the zero string.
Clearly, for $S,T\subseteq [n]$ we have $p_{S\cup T}=p_Sp_T=p_S\wedge p_T$, in particular,
$p_S=\Pi_jp_{\{j\}}$. 
\end{exm}

By the M\"obius transform, all boolean functions can be expressed as combinations of the functions $p_S$, $S\subseteq
[n]$ from the previous example.

\begin{theorem}\label{thm:basis} Any $f:\{0,1\}^n\to 2$ can be expressed  in the form 
\[
f=\sum_{S\subseteq [n]} \hat f_Sp_S
\]
in a unique way. The coefficients  $\hat f_S\in \mathbb R$ obtained as
\[
\hat f_S=\sum_{\substack{t\in \{0,1\}^n\\ t_j=1, \forall  j\in S^c}} (-1)^{\sum_{j\in
S}t_j}f(t).
\]

\end{theorem}

\begin{proof}  By the M\"obius inversion formula (see [Stanley, Sec. 3.7] for details),
functions $f, g: 2^n\to \mathbb R$ satisfy
\[
f(S)=\sum_{T\subseteq S} g(T),\qquad S\in 2^n
\]
if and only if 
\[
g(S)=\sum_{T\subseteq S}(-1)^{|S\setminus T|} f(T).
\]
We now express this in terms of the corresponding strings $s$ and $t$.
It is easily seen that $T\subseteq S$ if and only if
$s_j=0$ for all $j\in T$, equivalently, $t_j=1$ for all $j\in S^c$. Moreover,
in this case we have  $|S\setminus T|=\sum_{j\in S} t_j$. This shows that $g(S)=\hat f_S$,
as defined in the statement. The first equality now gives
\[
f(s)=f(S)=\sum_{T\subseteq S} g(T)=\sum_{T:s_i=0,\forall i\in T}\hat f_T=\sum_{T:
p_T(s)=1}\hat f_T=\sum_{T\subseteq [n]} \hat f_Tp_T.
\]
For uniqueness, assume that $f=\sum_{T\subseteq [n]} c_Tp_T$ for some coefficients $c_T\in
\mathbb R$. Then 
\[
f(s)=\sum_{T: p_T(s)=1}c_T=\sum_{T\subseteq S}c_T.
\]
Uniqueness now follows by  uniqueness in the M\"obius inversion formula.

\end{proof}





%For a string $x\in \{0,1\}^n$ and any set of indices $\{i_1,\dots,i_k\}\subseteq [n]$, we
%will denote by $x^{i_1\dots i_k}$ the string in $\{0,1\}^{n-k}$ obtained from $x$ by removing
%$x_{i_1},\dots, x_{i_k}$. 

\subsection{The boolean algebra $\Fe_n$}


Let us introduce the subset of boolean functions 
\[
\Fe_n:=\{f:\{0,1\}^n\to 2,\ f(\theta_n)=1\},
\]
where we use $\theta_n$ to denote the zero string $00\dots 0$. 
In other words, $\Fe_n$ is the interval of all elements greater than $p_{[n]}$ in the boolean algebra 
$2^{2^n}$ of all boolean functions. With the pointwise ordering, $\Fe_n$ is a distributive lattice, with top element $1_n$ and 
 bottom element $p_{[n]}$. We also define complementation  in $\Fe_n$ as
\[
f^*:=1_n-f+p_{[n]}.
\]
It can be easily checked that with these structures $\Fe_n$ is a boolean algebra, though
it is not a subalgebra of $2^{2^n}$.

We now introduce some more operations in $\Fe_n$. For $f\in \Fe_n$ and any permutation
$\sigma\in \permut_n$, we clearly have $f\circ \sigma\in \Fe_n$.
Further, let $f\in \Fe_{n_1}$ and $g\in \Fe_{n_2}$. With the decomposition
$[n_1+n_2]=[n_1]\oplus [n_2]$
and the corresponding concatenation of strings $s=s^1s^2$,  we define
the function $f\otimes g\in \Fe_{n_1+n_2}$ as
\[
(f\otimes g)(s^1s^2)=f(s^1)g(s^2),\qquad s^1\in \{0,1\}^{n_1},\ s^2\in \{0,1\}^{n_2}.
\]
Let $\lambda\in \permut_2$ be the transposition, then we have for any $f\in \Fe_{n_1}$ and
$g\in \Fe_{n_2}$
\[
(g\otimes f)=(f\otimes g)\circ \rho_\lambda,
\]
where $\rho_\lambda$ is the block permutation defined in  Section \ref{sec:permut}.
We now show some important properties of these operations.

\begin{lemma}\label{lemma:fproduct} For $f\in \Fe_{n_1}$ and  $g,h\in \Fe_{n_2}$, we have
\begin{enumerate}
\item[(i)] $f\otimes g\le (f^*\otimes g^*)^*$, with equality if and only if either
$f=1_{n_1}$ and $g=1_{n_2}$, or $f=p_{[n_1]}$ and $g=p_{[n_2]}$.
\item[(ii)] $f\otimes (g\vee h)= (f\otimes g)\vee (f\otimes h)$, $f\otimes (g\wedge h)=
(f\otimes g)\wedge (f\otimes h)$.
\end{enumerate}

\end{lemma}

\begin{proof} The inequality in (i) is easily  checked, since $(f\otimes g)(s^1s^2)$ can be 1 only if
$f(s^1)=g(s^2)=1$. If both $s^1$ and $s^2$ are the zero strings, then $s^1s^2=\theta_{n_1+n_2}$ and both sides
are equal to 1. Otherwise, the condition $f(s^1)=g(s^2)=1$ implies that $(f^*\otimes
g^*)(s^1s^2)=0$, so that the right hand side must be 1. If $f$ and $g$ are both
constant 1, then $(1_{n_1}\otimes 1_{n_2})^*=1_{n_1+n_2}^*=p_{[n_1+n_2]}=p_{[n_1]}\otimes
p_{[n_2]}=1_{n_1}^*\otimes
1_{n_2}^*$, in the case when both $f$
and $g$ are the minimal elements equality  follows by
duality. Finally, asume the equality holds and that $f\ne 1_{n_1}$, so that there is some $s^1$ such that 
$f(s^1)=0$. But then $s^1\ne \theta_{n_1}$, so that $f^*(s_1)=1$  and for any $s^2$,
\[
0=(f\otimes g)(s^1s^2)=(f^*\otimes
g^*)^*(s^1s^2)=1-f^*(s^1)g^*(s^2)+p_{[n_1+n_2]}(s^1s^2)=1-g^*(s^2),
\]
which implies that $g(s^2)=0$ for all $s^2\ne\theta_{n_2}$, that is, $g=p_{[n_2]}$. By the same argument,
$f=p_{[n_1]}$ if $g\ne 1_{n_2}$, which implies that either $f=1_{n_1}$ and $g=1_{n_2}$, or
$f=p_{[n_1]}$ and $g=p_{[n_2]}$.

The statement (ii) is easily proved from \eqref{eq:wedgevee_fun}.

\end{proof}

Consider the decomposition $[n]=[n_1]\oplus [n_2]$ and let $S\subseteq [n_1]$,
$T\subseteq [n_2]$. We then denote by $S\oplus T$ the disjoint union 
\begin{equation}\label{eq:disu}
S\oplus T:=S\cup (n_1+T)=S\cup\{n_1+j,\ j\in T\}.
\end{equation}
We summarize some easy properties of the basic functions $p_S$, $S\subseteq [n]$.

\begin{lemma}\label{lemma:PSPT}
\begin{enumerate}
\item[(i)] For $S,T\subseteq [n]$, we have $S\subseteq T$ $\iff$ $p_T\le p_S$ $\iff$
$p_Sp_T=p_S$.
\item[(ii)] For $S\subseteq [n]$, $\sigma\in \permut_n$,
$p_S\circ\sigma=p_{\sigma^{-1}(S)}$.
\item[(iii)] For $S\subseteq [n_1]$ and $T\subseteq [n_2]$, $p_S\otimes p_T=p_{S\oplus T}$.

\end{enumerate}
\end{lemma}

Let $f\in \Fe_n$ and let $\hat f$ be the M\"obius transform. Note that since $f$ has
values in $\{0,1\}$, we have by the proof of Theorem \ref{thm:basis}
\[
\forall S\in 2^n, \quad \sum_{T\subseteq S} \hat f_T=f(s)\in \{0,1\}; \qquad \sum_{T\in 2^n} \hat
f_T=f(\theta_n)=1.
\]



\begin{prop}\label{prop:mobius} 

\begin{enumerate}
\item[(i)] For $f\in \Fe_n$ and  $\sigma\in \permut_n$, 
$\widehat{(f\circ \sigma)}_S=\hat f_{\sigma(S)}, \qquad S\subseteq [n]$.
\item[(ii)] For $f\in \Fe_n$, $\widehat{f^*}_S=\begin{dcases} 1-\hat f_S & S=\emptyset\text{ or } S=[n],\\
-\hat f_S & \text{otherwise}.
\end{dcases}$
\item[(iii)] For $f\in \Fe_{n_1}$, $g\in \Fe_{n_2}$, we have 
$\widehat{(f\otimes g)}_{S\oplus T}=\hat f_S\hat g_T$, $S\subseteq [n_1]$, $T\subseteq
[n_2]$.
%\item[(iv)] For $f,g\in \Fe_n$, we have
%\[
%\widehat{(f\wedge g)}_S=\sum_{T\subseteq S} \hat f_T\hat g_{S\setminus T}.
%\]
%\item[(v)] For $f,g\in \Fe_n$, we have
%\[
%\widehat{(f\vee g)}_S=\hat f_S+\hat g_S-\sum_{T\subseteq S} \hat f_T\hat g_{S\setminus T}.
%\]
%
\end{enumerate}


\end{prop}

\begin{proof} All statements follow easily from Lemma \ref{lemma:PSPT} and the uniqueness part in Theorem
\ref{thm:basis}. 


\end{proof}

\section{Affine subspaces}
\label{sec:app_affine}
Let $V$ be a finite dimensional real vector space. A subset $A\subseteq V$ is an affine
subspace in $V$ if for any choice of  $a_1,\dots, a_k\in A$ and  $\alpha_1,\dots,\alpha_k\in \mathbb R$
such that $\sum_i\alpha_i=1$, we have $\sum_i\alpha_i a_i\in A$. It is clear that
$A=\emptyset$ is trivially an affine subspace.  Moreover, any linear subspace in $V$ is an affine subspace,
and an
affine subspace $A$ is linear if and only if $0\in A$. If $A \neq\emptyset$ and also
$0\notin A$, we say that $A$ is proper. 

A proper  affine subspace $A\subseteq V$ can be determined in two ways. Let 
\[
\lin(A):=\{a_1-a_2,\ a_1,a_2\in A\}.
\]
It is easily verified that $\lin(A)$ is a linear subspace, moreover, for any $a\in A$, we
have
\begin{equation}\label{eq:affine_l}
\lin(A)=\{a_1-a,\ a_1\in A\},\qquad A=a+\lin(A).
\end{equation}
We put $\dim(A):=\dim(\lin(A))$, the dimension of $A$. 

Let $V^*$ be the vector space dual of $V$ and let $\<\cdot,\cdot\>$ be the
duality. For a subset $C\subseteq V$, put
\[
\tilde C:=\{v^*\in V^*,\ \<v^*,a\>=1,\ \forall a\in A\}.
\]
Let $\tilde a\in \tilde A$ be any element and let $\Span(A)$ be the linear span of $A$ in
$V$. We then have
\begin{equation}\label{eq:affine_s}
A=\Span(A)\cap \{\tilde a\}^\sim,
\end{equation}
independently of $\tilde a$. The relation between the two expressions for $A$, given by
\eqref{eq:affine_l} and \eqref{eq:affine_s} is obtained as
\begin{equation}\label{eq:LandS}
\Span(A)=\lin(A)+\mathbb R\{a\},\qquad \lin(A)=\Span(A)\cap \{\tilde a\}^\perp,
\end{equation}
independently of $a\in A$ or $\tilde a\in \tilde A$. Here $+$ denotes the direct sum of
the vector spaces and $C^\perp$ denotes the annihilator of a set $C$.
The following lemma is  easily proven.

\begin{lemma}\label{lemma:dual} Let $C\subseteq V$ be any subset. Then $\tilde C$ is an affine subspace in 
$V^*$ and we have
\[
0\in \tilde C \iff C= \emptyset, \qquad \tilde C=\emptyset\iff 0\in \aff(C).
\]
Assume $C\ne \emptyset$ and $0\notin \aff(C)$. Then
\begin{enumerate}
\item[(i)] $\tilde C$ is proper and we have $\lin(\tilde C)=C^\perp=\Span(C)^\perp$,
\item[(ii)] $\aff(C)=\tilde{\tilde C}$ and for any $c_0\in
C$, we have
\begin{align*}
\lin(C):= \Span\{c_1-c_2,\ c_1,c_2\in C\}=\Span\{c-c_0,\ c\in C\}=\lin(\tilde{\tilde C}).
\end{align*}

\end{enumerate}


\end{lemma}

\begin{coro}\label{coro:dual} Let $A\subseteq V$ be a proper affine subspace. Then 
\begin{enumerate}
\item[(i)] $\tilde A$ is a proper affine subspace in $V^*$ and $\tilde{\tilde A}=A$.
\item[(ii)] $\lin(\tilde A)=\Span(A)^\perp$, $\Span(\tilde A)=\lin(A)^\perp$.
\item[(iii)] $\dim(\tilde A)=\dim(V)-\dim(A)-1$.
\end{enumerate}


\end{coro}

The proper affine subspace $\tilde A$ in the above Corollary will be called the affine dual
of $A$. Note that the dual depends on the choice of the ambient vector space $V$.

\end{document}
